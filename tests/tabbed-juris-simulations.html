<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juris Computational Simulations - Tabbed Interface</title>
    <script src="../src/juris.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: white;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #ff6b6b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            opacity: 0.7;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 120px;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .simulation-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .sim-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .sim-title {
            color: #667eea;
            font-size: 1.8rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sim-description {
            opacity: 0.8;
            font-size: 14px;
            max-width: 400px;
            line-height: 1.4;
        }

        .controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 120px;
        }

        .control-group label {
            font-size: 11px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        button.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }

        input[type="range"] {
            width: 140px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
        }

        input[type="color"] {
            width: 50px;
            height: 35px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .demo-container {
            position: relative;
            height: 400px;
            border: 2px dashed rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            overflow: hidden;
            background: radial-gradient(circle at 30% 30%, rgba(102, 126, 234, 0.1), transparent 50%),
                        radial-gradient(circle at 70% 70%, rgba(255, 107, 107, 0.1), transparent 50%),
                        #0f0f0f;
        }

        .value-display {
            font-size: 12px;
            opacity: 0.8;
            font-weight: 600;
            color: #667eea;
        }

        .fps-counter {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            color: #4ecdc4;
            z-index: 1000;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 18px;
            opacity: 0.6;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .tabs {
                gap: 3px;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 100px;
            }
            
            .controls {
                gap: 15px;
            }
            
            .sim-header {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="fps-counter" id="fps-counter">FPS: 60</div>
    
    <div class="header">
        <h1>Juris Computational Simulations</h1>
        <p class="subtitle">Advanced physics simulations using reactive DOM styles</p>
        
        <div class="tabs">
            <button class="tab active" data-sim="nbody">üåå N-Body</button>
            <button class="tab" data-sim="fluid">üåä Fluid</button>
            <button class="tab" data-sim="field">‚ö° Fields</button>
            <button class="tab" data-sim="wave">„Ä∞Ô∏è Waves</button>
            <button class="tab" data-sim="quantum">üî¨ Quantum</button>
        </div>
    </div>

    <div class="simulation-container">
        <!-- N-Body Simulation -->
        <div id="sim-nbody" class="simulation">
            <div class="sim-header">
                <div>
                    <h2 class="sim-title">üåå Gravitational N-Body System</h2>
                    <p class="sim-description">Real gravitational mechanics between celestial bodies with orbital perturbations and complex interactions.</p>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Bodies</label>
                    <input type="range" id="nbody-count" min="3" max="12" step="1" value="6">
                    <span class="value-display" id="nbody-count-val">6</span>
                </div>
                <div class="control-group">
                    <label>Gravity</label>
                    <input type="range" id="gravity-strength" min="10" max="200" step="10" value="80">
                    <span class="value-display" id="gravity-val">80</span>
                </div>
                <div class="control-group">
                    <label>Time Scale</label>
                    <input type="range" id="time-scale" min="0.1" max="3" step="0.1" value="1">
                    <span class="value-display" id="time-scale-val">1</span>
                </div>
                <div class="control-group">
                    <label>Reset</label>
                    <button id="nbody-reset">Reset System</button>
                </div>
            </div>
            <div class="demo-container" id="nbody-container">
                <div class="loading">Initializing gravitational simulation...</div>
            </div>
        </div>

        <!-- Fluid Simulation -->
        <div id="sim-fluid" class="simulation hidden">
            <div class="sim-header">
                <div>
                    <h2 class="sim-title">üåä Fluid Flow Simulation</h2>
                    <p class="sim-description">Simplified Navier-Stokes equations with viscosity, turbulence, and flow velocity calculations.</p>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Viscosity</label>
                    <input type="range" id="fluid-viscosity" min="0.1" max="2" step="0.1" value="0.8">
                    <span class="value-display" id="viscosity-val">0.8</span>
                </div>
                <div class="control-group">
                    <label>Flow Speed</label>
                    <input type="range" id="fluid-speed" min="0.5" max="4" step="0.1" value="1.5">
                    <span class="value-display" id="flow-speed-val">1.5</span>
                </div>
                <div class="control-group">
                    <label>Turbulence</label>
                    <input type="range" id="turbulence" min="0" max="100" step="5" value="30">
                    <span class="value-display" id="turbulence-val">30</span>
                </div>
                <div class="control-group">
                    <label>Color Mode</label>
                    <button id="fluid-color-mode">Velocity</button>
                </div>
            </div>
            <div class="demo-container" id="fluid-container">
                <div class="loading">Preparing fluid dynamics...</div>
            </div>
        </div>

        <!-- Field Simulation -->
        <div id="sim-field" class="simulation hidden">
            <div class="sim-header">
                <div>
                    <h2 class="sim-title">‚ö° Electromagnetic Fields</h2>
                    <p class="sim-description">Electric and magnetic field line visualization with real-time field strength calculations.</p>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Field Lines</label>
                    <input type="range" id="field-density" min="8" max="25" step="1" value="15">
                    <span class="value-display" id="field-density-val">15</span>
                </div>
                <div class="control-group">
                    <label>Charge Strength</label>
                    <input type="range" id="charge-strength" min="50" max="300" step="25" value="150">
                    <span class="value-display" id="charge-val">150</span>
                </div>
                <div class="control-group">
                    <label>Animation Speed</label>
                    <input type="range" id="field-speed" min="0.2" max="3" step="0.2" value="1">
                    <span class="value-display" id="field-speed-val">1</span>
                </div>
                <div class="control-group">
                    <label>Field Type</label>
                    <button id="field-type">Electric</button>
                </div>
            </div>
            <div class="demo-container" id="field-container">
                <div class="loading">Generating electromagnetic field...</div>
            </div>
        </div>

        <!-- Wave Simulation -->
        <div id="sim-wave" class="simulation hidden">
            <div class="sim-header">
                <div>
                    <h2 class="sim-title">„Ä∞Ô∏è Wave Interference Patterns</h2>
                    <p class="sim-description">Multiple wave source interference with real-time wave equation solving and pattern visualization.</p>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Wave Sources</label>
                    <input type="range" id="wave-sources" min="2" max="6" step="1" value="3">
                    <span class="value-display" id="wave-sources-val">3</span>
                </div>
                <div class="control-group">
                    <label>Frequency</label>
                    <input type="range" id="wave-frequency" min="0.5" max="4" step="0.1" value="1.2">
                    <span class="value-display" id="frequency-val">1.2</span>
                </div>
                <div class="control-group">
                    <label>Amplitude</label>
                    <input type="range" id="wave-amplitude" min="10" max="80" step="5" value="40">
                    <span class="value-display" id="amplitude-val">40</span>
                </div>
                <div class="control-group">
                    <label>Wave Type</label>
                    <button id="wave-type">Sine</button>
                </div>
            </div>
            <div class="demo-container" id="wave-container">
                <div class="loading">Calculating wave interference...</div>
            </div>
        </div>

        <!-- Quantum Simulation -->
        <div id="sim-quantum" class="simulation hidden">
            <div class="sim-header">
                <div>
                    <h2 class="sim-title">üî¨ Quantum Wave Function</h2>
                    <p class="sim-description">Quantum orbital probability calculations with Heisenberg uncertainty principle and observation effects.</p>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Energy Level</label>
                    <input type="range" id="quantum-energy" min="1" max="8" step="1" value="3">
                    <span class="value-display" id="energy-val">3</span>
                </div>
                <div class="control-group">
                    <label>Uncertainty</label>
                    <input type="range" id="uncertainty" min="0.1" max="2" step="0.1" value="0.7">
                    <span class="value-display" id="uncertainty-val">0.7</span>
                </div>
                <div class="control-group">
                    <label>Observation Rate</label>
                    <input type="range" id="observation-rate" min="0" max="100" step="10" value="30">
                    <span class="value-display" id="observation-val">30</span>
                </div>
                <div class="control-group">
                    <label>Orbital Type</label>
                    <button id="orbital-type">S-Orbital</button>
                </div>
            </div>
            <div class="demo-container" id="quantum-container">
                <div class="loading">Modeling quantum mechanics...</div>
            </div>
        </div>
            <div class="sim-header">
                <div>
                    <h2 class="sim-title">„Ä∞Ô∏è Wave Interference Patterns</h2>
                    <p class="sim-description">Multiple wave source interference with real-time wave equation solving and pattern visualization.</p>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Wave Sources</label>
                    <input type="range" id="wave-sources" min="2" max="6" step="1" value="3">
                    <span class="value-display" id="wave-sources-val">3</span>
                </div>
                <div class="control-group">
                    <label>Frequency</label>
                    <input type="range" id="wave-frequency" min="0.5" max="4" step="0.1" value="1.2">
                    <span class="value-display" id="frequency-val">1.2</span>
                </div>
                <div class="control-group">
                    <label>Amplitude</label>
                    <input type="range" id="wave-amplitude" min="10" max="80" step="5" value="40">
                    <span class="value-display" id="amplitude-val">40</span>
                </div>
                <div class="control-group">
                    <label>Wave Type</label>
                    <button id="wave-type">Sine</button>
                </div>
            </div>
            <div class="demo-container" id="wave-container">
                <div class="loading">Calculating wave interference...</div>
            </div>
        </div>

        <!-- Quantum Simulation -->
        <div id="sim-quantum" class="simulation hidden">
            <div class="sim-header">
                <div>
                    <h2 class="sim-title">üî¨ Quantum Wave Function</h2>
                    <p class="sim-description">Quantum orbital probability calculations with Heisenberg uncertainty principle and observation effects.</p>
                </div>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label>Energy Level</label>
                    <input type="range" id="quantum-energy" min="1" max="8" step="1" value="3">
                    <span class="value-display" id="energy-val">3</span>
                </div>
                <div class="control-group">
                    <label>Uncertainty</label>
                    <input type="range" id="uncertainty" min="0.1" max="2" step="0.1" value="0.7">
                    <span class="value-display" id="uncertainty-val">0.7</span>
                </div>
                <div class="control-group">
                    <label>Observation Rate</label>
                    <input type="range" id="observation-rate" min="0" max="100" step="10" value="30">
                    <span class="value-display" id="observation-val">30</span>
                </div>
                <div class="control-group">
                    <label>Orbital Type</label>
                    <button id="orbital-type">S-Orbital</button>
                </div>
            </div>
            <div class="demo-container" id="quantum-container">
                <div class="loading">Modeling quantum mechanics...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Juris
        const juris = new Juris({
            renderMode: 'fine-grained',
            logLevel: 'error'
        });

        // Global state
        let animationFrame;
        let startTime = Date.now();
        let frameCount = 0;
        let lastFpsUpdate = Date.now();
        let currentSimulation = 'nbody';
        let simulationRendered = new Set();

        // Initialize all state
        juris.setState('time', 0);
        juris.setState('activeSimulation', 'nbody'); // Track active simulation
        juris.setState('mouse.x', 0);
        juris.setState('mouse.y', 0);
        
        // Initialize states for all simulations
        juris.setState('nbody.count', 6);
        juris.setState('nbody.gravity', 80);
        juris.setState('nbody.timeScale', 1);
        juris.setState('nbody.reset', 0);

        juris.setState('fluid.viscosity', 0.8);
        juris.setState('fluid.speed', 1.5);
        juris.setState('fluid.turbulence', 30);
        juris.setState('fluid.colorMode', 'velocity');

        juris.setState('field.density', 15);
        juris.setState('field.strength', 150);
        juris.setState('field.speed', 1);
        juris.setState('field.type', 'electric');

        juris.setState('wave.sources', 3);
        juris.setState('wave.frequency', 1.2);
        juris.setState('wave.amplitude', 40);
        juris.setState('wave.type', 'sine');

        juris.setState('quantum.energy', 3);
        juris.setState('quantum.uncertainty', 0.7);
        juris.setState('quantum.observation', 30);
        juris.setState('quantum.orbital', 's');

        // Mouse tracking
        document.addEventListener('mousemove', (e) => {
            juris.setState('mouse.x', e.clientX);
            juris.setState('mouse.y', e.clientY);
        });

        // FPS counter
        function updateFPS() {
            frameCount++;
            const now = Date.now();
            if (now - lastFpsUpdate >= 1000) {
                const fps = Math.round(frameCount * 1000 / (now - lastFpsUpdate));
                document.getElementById('fps-counter').textContent = `FPS: ${fps}`;
                frameCount = 0;
                lastFpsUpdate = now;
            }
        }

        // Animation loop
        function animate() {
            const currentTime = (Date.now() - startTime) / 1000;
            juris.setState('time', currentTime);
            updateFPS();
            animationFrame = requestAnimationFrame(animate);
        }

        // Simulation creation functions (same as before but optimized)
        const createNBody = (index) => ({
            div: {
                style: (element) => {
                    // Only update if this simulation is active
                    const activeSimulation = juris.getState('activeSimulation', 'nbody');
                    if (activeSimulation !== 'nbody') {
                        return {}; // Return empty style to prevent updates
                    }

                    const time = juris.getState('time', 0);
                    const gravity = juris.getState('nbody.gravity', 80);
                    const timeScale = juris.getState('nbody.timeScale', 1);
                    const resetCounter = juris.getState('nbody.reset', 0);
                    const totalBodies = juris.getState('nbody.count', 6);

                    const angle = (index * Math.PI * 2) / totalBodies;
                    const radius = 50 + index * 12;
                    const resetTime = resetCounter * 1000;
                    const adjustedTime = (time * timeScale) + resetTime;

                    let x = 200 + Math.cos(adjustedTime * 0.3 + angle) * radius;
                    let y = 200 + Math.sin(adjustedTime * 0.3 + angle) * radius * 0.7;

                    // Gravitational perturbations
                    for (let i = 0; i < totalBodies; i++) {
                        if (i !== index) {
                            const otherAngle = (i * Math.PI * 2) / totalBodies;
                            const otherRadius = 50 + i * 12;
                            const otherX = 200 + Math.cos(adjustedTime * 0.3 + otherAngle) * otherRadius;
                            const otherY = 200 + Math.sin(adjustedTime * 0.3 + otherAngle) * otherRadius * 0.7;
                            
                            const dx = otherX - x;
                            const dy = otherY - y;
                            const distance = Math.sqrt(dx * dx + dy * dy) + 10;
                            const force = gravity / (distance * distance);
                            
                            x += (dx / distance) * force * 0.08;
                            y += (dy / distance) * force * 0.08;
                        }
                    }

                    const mass = 6 + index * 2;
                    const hue = (3000 + index * 500) / 50 % 360;

                    return {
                        position: 'absolute',
                        width: `${mass * 2}px`,
                        height: `${mass * 2}px`,
                        background: `radial-gradient(circle, hsl(${hue}, 80%, 70%), hsl(${hue}, 60%, 40%))`,
                        borderRadius: '50%',
                        left: `${x}px`,
                        top: `${y}px`,
                        transform: 'translate(-50%, -50%)',
                        boxShadow: `0 0 ${mass * 3}px hsl(${hue}, 80%, 60%)`,
                        filter: `blur(${Math.sin(adjustedTime + index) * 0.3 + 0.3}px)`
                    };
                }
            }
        });

        const createFluidParticle = (index) => ({
            div: {
                style: () => {
                    // Only update if this simulation is active
                    const activeSimulation = juris.getState('activeSimulation', 'nbody');
                    if (activeSimulation !== 'fluid') {
                        return {}; // Return empty style to prevent updates
                    }

                    const time = juris.getState('time', 0);
                    const viscosity = juris.getState('fluid.viscosity', 0.8);
                    const speed = juris.getState('fluid.speed', 1.5);
                    const turbulence = juris.getState('fluid.turbulence', 30);

                    const x = (index % 25) * 16;
                    const y = Math.floor(index / 25) * 16;
                    const flowTime = time * speed;
                    
                    const vx = Math.sin(flowTime + x * 0.05) * (1 - viscosity);
                    const vy = Math.cos(flowTime + y * 0.05) * (1 - viscosity);
                    const noise = Math.sin(flowTime * 3 + x * 0.1 + y * 0.1) * (turbulence / 100);
                    
                    const finalX = x + vx * 15 + noise * 8;
                    const finalY = y + vy * 15 + noise * 8;
                    
                    const velocity = Math.sqrt(vx * vx + vy * vy);
                    const hue = 240 - velocity * 120;

                    return {
                        position: 'absolute',
                        width: '6px',
                        height: '6px',
                        background: `hsl(${hue}, 70%, 60%)`,
                        borderRadius: '50%',
                        left: `${finalX}px`,
                        top: `${finalY}px`,
                        transform: 'translate(-50%, -50%)',
                        opacity: 0.4 + velocity * 0.4,
                        filter: `blur(${viscosity * 0.5}px)`
                    };
                }
            }
        });

        const createFieldLine = (index) => ({
            div: {
                style: () => {
                    // Only update if this simulation is active
                    const activeSimulation = juris.getState('activeSimulation', 'nbody');
                    if (activeSimulation !== 'field') {
                        return {}; // Return empty style to prevent updates
                    }

                    const time = juris.getState('time', 0);
                    const density = juris.getState('field.density', 15);
                    const strength = juris.getState('field.strength', 150);
                    const fieldSpeed = juris.getState('field.speed', 1);
                    const fieldType = juris.getState('field.type', 'electric');

                    const angle = (index / density) * Math.PI * 2;
                    const radius = 40 + (index % 3) * 25;
                    
                    let x, y, rotation;
                    if (fieldType === 'electric') {
                        x = 200 + Math.cos(angle) * radius;
                        y = 200 + Math.sin(angle) * radius;
                        rotation = (angle * 180 / Math.PI) + (time * fieldSpeed * 30);
                    } else {
                        x = 200 + Math.cos(angle + time * fieldSpeed) * radius;
                        y = 200 + Math.sin(angle + time * fieldSpeed) * radius;
                        rotation = (angle * 180 / Math.PI) + 90 + (time * fieldSpeed * 60);
                    }

                    const hue = fieldType === 'electric' ? 60 : 280;
                    const length = Math.min(strength / 6, 35);

                    return {
                        position: 'absolute',
                        width: `${length}px`,
                        height: '2px',
                        background: `linear-gradient(90deg, transparent, hsl(${hue}, 80%, 60%), transparent)`,
                        left: `${x}px`,
                        top: `${y}px`,
                        transform: `translate(-50%, -50%) rotate(${rotation}deg)`,
                        boxShadow: `0 0 5px hsl(${hue}, 80%, 60%)`,
                        opacity: 0.7
                    };
                }
            }
        });

        const createWavePoint = (index) => ({
            div: {
                style: () => {
                    // Only update if this simulation is active
                    const activeSimulation = juris.getState('activeSimulation', 'nbody');
                    if (activeSimulation !== 'wave') {
                        return {}; // Return empty style to prevent updates
                    }

                    const time = juris.getState('time', 0);
                    const sources = juris.getState('wave.sources', 3);
                    const frequency = juris.getState('wave.frequency', 1.2);
                    const amplitude = juris.getState('wave.amplitude', 40);
                    const waveType = juris.getState('wave.type', 'sine');

                    const x = (index % 30) * 13;
                    const y = Math.floor(index / 30) * 13;
                    
                    let totalWave = 0;
                    for (let s = 0; s < sources; s++) {
                        const sourceAngle = (s / sources) * Math.PI * 2;
                        const sourceX = 200 + Math.cos(sourceAngle) * 60;
                        const sourceY = 200 + Math.sin(sourceAngle) * 60;
                        
                        const distance = Math.sqrt((x - sourceX) ** 2 + (y - sourceY) ** 2);
                        const phase = time * frequency - distance * 0.08;
                        
                        if (waveType === 'sine') {
                            totalWave += Math.sin(phase);
                        } else {
                            totalWave += Math.sign(Math.sin(phase));
                        }
                    }
                    
                    const normalizedWave = totalWave / sources;
                    const height = Math.abs(normalizedWave) * amplitude;
                    const hue = (normalizedWave + 1) * 180;

                    return {
                        position: 'absolute',
                        width: '3px',
                        height: '3px',
                        background: `hsl(${hue}, 80%, ${50 + normalizedWave * 30}%)`,
                        borderRadius: '50%',
                        left: `${x}px`,
                        top: `${y - height * 0.3}px`,
                        transform: 'translate(-50%, -50%)',
                        boxShadow: `0 0 ${height * 0.1}px hsl(${hue}, 80%, 60%)`,
                        opacity: 0.6 + Math.abs(normalizedWave) * 0.4
                    };
                }
            }
        });

        const createQuantumParticle = (index) => ({
            div: {
                style: () => {
                    // Only update if this simulation is active
                    const activeSimulation = juris.getState('activeSimulation', 'nbody');
                    if (activeSimulation !== 'quantum') {
                        return {}; // Return empty style to prevent updates
                    }

                    const time = juris.getState('time', 0);
                    const energy = juris.getState('quantum.energy', 3);
                    const uncertainty = juris.getState('quantum.uncertainty', 0.7);
                    const observation = juris.getState('quantum.observation', 30);
                    const orbital = juris.getState('quantum.orbital', 's');

                    let x, y, probability;
                    
                    if (orbital === 's') {
                        const r = 40 + Math.random() * 30 * uncertainty;
                        const theta = Math.random() * Math.PI * 2;
                        x = 200 + Math.cos(theta) * r * Math.sin(time * 0.3 + index);
                        y = 200 + Math.sin(theta) * r * Math.sin(time * 0.3 + index);
                        probability = Math.exp(-r / (energy * 8));
                    } else {
                        const r = 35 + Math.random() * 25 * uncertainty;
                        const theta = index < 50 ? 0 : Math.PI;
                        x = 200 + Math.cos(theta + time * 0.2) * r;
                        y = 200 + Math.sin(theta + time * 0.2) * r * 0.3;
                        probability = Math.exp(-r / (energy * 6));
                    }

                    const observationEffect = observation / 100;
                    const blur = uncertainty * (1 - observationEffect) * 1.5;
                    
                    // Enhanced contrast: stronger opacity difference and brighter colors
                    const baseOpacity = probability * (0.4 + observationEffect * 0.6);
                    const contrastOpacity = Math.pow(baseOpacity, 0.7); // Gamma correction for more contrast
                    
                    // Brighter, more saturated colors
                    const hue = 280 + energy * 20;
                    const saturation = 90;
                    const lightness = 75 + probability * 25; // Higher base lightness
                    
                    // Larger particles for better visibility
                    const size = 3 + probability * 2;

                    return {
                        position: 'absolute',
                        width: `${size}px`,
                        height: `${size}px`,
                        background: `hsl(${hue}, ${saturation}%, ${lightness}%)`,
                        borderRadius: '50%',
                        left: `${x}px`,
                        top: `${y}px`,
                        transform: 'translate(-50%, -50%)',
                        opacity: Math.max(contrastOpacity, 0.1), // Minimum visibility
                        filter: `blur(${blur}px) brightness(1.3) saturate(1.2)`,
                        boxShadow: `0 0 ${4 + energy * 2}px hsl(${hue}, ${saturation}%, ${lightness}%),
                                   0 0 ${8 + energy * 3}px hsl(${hue}, ${saturation}%, ${lightness}%, 0.3)`
                    };
                }
            }
        });

        // Render functions
        function renderSimulation(simType) {
            const container = document.getElementById(`${simType}-container`);
            let elements = [];
            
            switch(simType) {
                case 'nbody':
                    const nbodyCount = juris.getState('nbody.count', 6);
                    elements = Array.from({ length: nbodyCount }, (_, i) => createNBody(i));
                    break;
                case 'fluid':
                    elements = Array.from({ length: 400 }, (_, i) => createFluidParticle(i));
                    break;
                case 'field':
                    const fieldDensity = juris.getState('field.density', 15);
                    elements = Array.from({ length: fieldDensity }, (_, i) => createFieldLine(i));
                    break;
                case 'wave':
                    elements = Array.from({ length: 900 }, (_, i) => createWavePoint(i));
                    break;
                case 'quantum':
                    elements = Array.from({ length: 100 }, (_, i) => createQuantumParticle(i));
                    break;
            }
            
            const element = juris.domRenderer.render({ div: { children: elements } });
            container.innerHTML = '';
            container.appendChild(element);
            simulationRendered.add(simType);
        }

        // Tab switching
        function switchToSimulation(simType) {
            // Hide current simulation
            document.getElementById(`sim-${currentSimulation}`).classList.add('hidden');
            
            // Show new simulation
            document.getElementById(`sim-${simType}`).classList.remove('hidden');
            
            // Update tab states
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.sim === simType);
            });
            
            // Update active simulation state - this isolates reactivity!
            juris.setState('activeSimulation', simType);
            
            currentSimulation = simType;
            
            // Render simulation if not already rendered
            if (!simulationRendered.has(simType)) {
                setTimeout(() => renderSimulation(simType), 100);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchToSimulation(tab.dataset.sim);
                });
            });

            // N-Body controls
            document.getElementById('nbody-count').addEventListener('input', (e) => {
                const count = parseInt(e.target.value);
                juris.setState('nbody.count', count);
                document.getElementById('nbody-count-val').textContent = count;
                if (currentSimulation === 'nbody') renderSimulation('nbody');
            });

            document.getElementById('gravity-strength').addEventListener('input', (e) => {
                const gravity = parseInt(e.target.value);
                juris.setState('nbody.gravity', gravity);
                document.getElementById('gravity-val').textContent = gravity;
            });

            document.getElementById('time-scale').addEventListener('input', (e) => {
                const scale = parseFloat(e.target.value);
                juris.setState('nbody.timeScale', scale);
                document.getElementById('time-scale-val').textContent = scale;
            });

            document.getElementById('nbody-reset').addEventListener('click', () => {
                juris.setState('nbody.reset', juris.getState('nbody.reset', 0) + 1);
            });

            // Continue with other controls...
            // Fluid controls
            document.getElementById('fluid-viscosity').addEventListener('input', (e) => {
                const viscosity = parseFloat(e.target.value);
                juris.setState('fluid.viscosity', viscosity);
                document.getElementById('viscosity-val').textContent = viscosity;
            });

            document.getElementById('fluid-speed').addEventListener('input', (e) => {
                const speed = parseFloat(e.target.value);
                juris.setState('fluid.speed', speed);
                document.getElementById('flow-speed-val').textContent = speed;
            });

            document.getElementById('turbulence').addEventListener('input', (e) => {
                const turbulence = parseInt(e.target.value);
                juris.setState('fluid.turbulence', turbulence);
                document.getElementById('turbulence-val').textContent = turbulence;
            });

            document.getElementById('fluid-color-mode').addEventListener('click', (e) => {
                const mode = juris.getState('fluid.colorMode', 'velocity');
                const newMode = mode === 'velocity' ? 'pressure' : 'velocity';
                juris.setState('fluid.colorMode', newMode);
                e.target.textContent = newMode === 'velocity' ? 'Pressure' : 'Velocity';
                e.target.classList.toggle('active', newMode === 'pressure');
            });

            // Field controls  
            document.getElementById('field-density').addEventListener('input', (e) => {
                const density = parseInt(e.target.value);
                juris.setState('field.density', density);
                document.getElementById('field-density-val').textContent = density;
                if (currentSimulation === 'field') renderSimulation('field');
            });

            document.getElementById('charge-strength').addEventListener('input', (e) => {
                const strength = parseInt(e.target.value);
                juris.setState('field.strength', strength);
                document.getElementById('charge-val').textContent = strength;
            });

            document.getElementById('field-speed').addEventListener('input', (e) => {
                const speed = parseFloat(e.target.value);
                juris.setState('field.speed', speed);
                document.getElementById('field-speed-val').textContent = speed;
            });

            document.getElementById('field-type').addEventListener('click', (e) => {
                const type = juris.getState('field.type', 'electric');
                const newType = type === 'electric' ? 'magnetic' : 'electric';
                juris.setState('field.type', newType);
                e.target.textContent = newType === 'electric' ? 'Magnetic' : 'Electric';
                e.target.classList.toggle('active', newType === 'magnetic');
            });

            // Wave controls
            document.getElementById('wave-sources').addEventListener('input', (e) => {
                const sources = parseInt(e.target.value);
                juris.setState('wave.sources', sources);
                document.getElementById('wave-sources-val').textContent = sources;
            });

            document.getElementById('wave-frequency').addEventListener('input', (e) => {
                const frequency = parseFloat(e.target.value);
                juris.setState('wave.frequency', frequency);
                document.getElementById('frequency-val').textContent = frequency;
            });

            document.getElementById('wave-amplitude').addEventListener('input', (e) => {
                const amplitude = parseInt(e.target.value);
                juris.setState('wave.amplitude', amplitude);
                document.getElementById('amplitude-val').textContent = amplitude;
            });

            document.getElementById('wave-type').addEventListener('click', (e) => {
                const types = ['sine', 'square', 'sawtooth'];
                const current = juris.getState('wave.type', 'sine');
                const nextIndex = (types.indexOf(current) + 1) % types.length;
                const newType = types[nextIndex];
                juris.setState('wave.type', newType);
                e.target.textContent = newType.charAt(0).toUpperCase() + newType.slice(1);
            });

            // Quantum controls
            document.getElementById('quantum-energy').addEventListener('input', (e) => {
                const energy = parseInt(e.target.value);
                juris.setState('quantum.energy', energy);
                document.getElementById('energy-val').textContent = energy;
            });

            document.getElementById('uncertainty').addEventListener('input', (e) => {
                const uncertainty = parseFloat(e.target.value);
                juris.setState('quantum.uncertainty', uncertainty);
                document.getElementById('uncertainty-val').textContent = uncertainty;
            });

            document.getElementById('observation-rate').addEventListener('input', (e) => {
                const observation = parseInt(e.target.value);
                juris.setState('quantum.observation', observation);
                document.getElementById('observation-val').textContent = observation;
            });

            document.getElementById('orbital-type').addEventListener('click', (e) => {
                const orbitals = ['s', 'p', 'd'];
                const current = juris.getState('quantum.orbital', 's');
                const nextIndex = (orbitals.indexOf(current) + 1) % orbitals.length;
                const newOrbital = orbitals[nextIndex];
                juris.setState('quantum.orbital', newOrbital);
                e.target.textContent = `${newOrbital.toUpperCase()}-Orbital`;
            });
        }

        // Initialize
        setupEventListeners();
        
        // Render initial simulation after a short delay
        setTimeout(() => {
            renderSimulation('nbody');
        }, 500);

        // Start animation
        animate();

        console.log('üöÄ Tabbed Juris Simulations loaded!');
        console.log('Click tabs to switch between different physics simulations.');
        console.log('Each simulation only renders when selected for optimal performance.');
    </script>
</body>
</html>