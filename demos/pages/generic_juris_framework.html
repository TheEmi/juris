<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juris Framework - Todo App Demo</title>
    <link rel="stylesheet" href="todo.css">
</head>
<body>
    <h1>üìù Juris Todo App</h1>
    
    <div class="container">
        <div id="app"></div>
        <div id="errorArea"></div>
    </div>
    <script src="juris.js"></script>
    <script>        
        // Enhanced Todo App Demo with comprehensive routing and guards
        const app = new Juris({
            states: {
                todos: [],
                filter: 'all',
                editingId: null,
                editText: '',
                newTodoText: '',
                user: {
                    isAuthenticated: false,
                    isAdmin: false,
                    username: '',
                    hasProfile: false
                },
                router: { 
                    currentRoute: '/',
                    isLoading: false,
                    hasUnsavedChanges: false,
                    error: null,
                    params: {}
                }
            },
            
            router: {
                routes: {
                    '/': 'HomePage',
                    '/stats': {
                        component: 'StatsPage',
                        guards: ['authGuard']
                    },
                    '/admin': {
                        component: 'AdminPage',
                        guards: ['authGuard', 'adminGuard'],
                        loadData: 'loadAdminData'
                    },
                    '/profile': {
                        component: 'ProfilePage',
                        guards: ['authGuard', 'profileGuard']
                    },
                    '/user/:id': {
                        component: 'UserPage',
                        guards: ['authGuard'],
                        loadData: 'loadUserData'
                    },
                    '/login': 'LoginPage',
                    '/unauthorized': 'UnauthorizedPage'
                },
                
                guards: {
                    authGuard: ({ getState, navigate }) => {
                        if (!getState('user.isAuthenticated')) {
                            navigate('/login');
                            return false;
                        }
                        return true;
                    },
                    
                    adminGuard: ({ getState, navigate }) => {
                        if (!getState('user.isAdmin')) {
                            navigate('/unauthorized');
                            return false;
                        }
                        return true;
                    },
                    
                    profileGuard: ({ getState, navigate }) => {
                        if (!getState('user.hasProfile')) {
                            alert('Please complete your profile first');
                            navigate('/');
                            return false;
                        }
                        return true;
                    },
                    
                    loadAdminData: async ({ setState }) => {
                        // Simulate loading admin data
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        setState('adminData', { 
                            users: 150, 
                            todos: 2500,
                            lastUpdate: new Date().toISOString()
                        });
                    },
                    
                    loadUserData: async ({ params, setState }) => {
                        // Simulate loading user data
                        await new Promise(resolve => setTimeout(resolve, 800));
                        setState('currentUser', {
                            id: params.id,
                            name: `User ${params.id}`,
                            todos: Math.floor(Math.random() * 20)
                        });
                    }
                },
                
                middleware: [
                    {
                        path: '/admin/*',
                        guard: ({ getState, navigate }) => {
                            console.log('Admin middleware check');
                            return getState('user.isAdmin', false);
                        }
                    }
                ]
            },
            
            middleware: [
                // Logging middleware
                ({ path, oldValue, newValue }) => {
                    console.log(`State change: ${path} ${JSON.stringify(oldValue)} -> ${JSON.stringify(newValue)}`);
                    return newValue;
                },
                
                // LocalStorage sync middleware
                ({ path, newValue, context }) => {
                    // Define which paths to persist
                    const persistPaths = ['todos', 'user', 'filter'];
                    
                    // Check if this path should be persisted
                    const shouldPersist = persistPaths.some(persistPath => 
                        path === persistPath || path.startsWith(persistPath + '.')
                    );
                    
                    // Skip persistence if explicitly disabled or from cross-tab sync
                    if (shouldPersist && context.skipPersist !== true && context.crossTabSync !== true) {
                        try {
                            // Get the root path (first part before any dots)
                            const rootPath = path.split('.')[0];
                            
                            // Get the current state for this root path
                            let currentState = {};
                            if (typeof Storage !== 'undefined') {
                                const stored = localStorage.getItem(`juris_${rootPath}`);
                                if (stored) {
                                    currentState = JSON.parse(stored);
                                }
                            }
                            
                            // Update the nested value
                            const pathParts = path.split('.');
                            if (pathParts.length === 1) {
                                // Root level update
                                currentState = newValue;
                            } else {
                                // Nested update - reconstruct the object
                                let current = currentState;
                                for (let i = 1; i < pathParts.length - 1; i++) {
                                    if (!current[pathParts[i]]) {
                                        current[pathParts[i]] = {};
                                    }
                                    current = current[pathParts[i]];
                                }
                                current[pathParts[pathParts.length - 1]] = newValue;
                            }
                            
                            // Save to localStorage (this will trigger storage event in other tabs)
                            if (typeof Storage !== 'undefined') {
                                localStorage.setItem(`juris_${rootPath}`, JSON.stringify(currentState));
                                console.log(`üíæ Persisted ${rootPath} to localStorage`);
                            }
                        } catch (error) {
                            console.error('LocalStorage sync error:', error);
                        }
                    }
                    
                    return newValue;
                }
            ],
            
            services: {
                todoService: {
                    createTodo: (text) => ({
                        id: Date.now() + Math.random(),
                        text: text.trim(),
                        completed: false,
                        createdAt: new Date().toISOString()
                    }),
                
                SyncStatus: (props, { getState, setState, services }) => ({
                    div: {
                        style: { 
                            background: '#f5f5f5', 
                            padding: '15px', 
                            borderRadius: '8px', 
                            marginBottom: '20px',
                            border: '1px solid #e0e0e0'
                        },
                        children: () => {
                            const syncEnabled = services.remoteSyncService.config.enabled;
                            const lastSync = getState('sync.lastSync', 0);
                            const lastSyncText = lastSync ? new Date(lastSync).toLocaleTimeString() : 'Never';
                            
                            return [{
                                div: {
                                    style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', flexWrap: 'wrap', gap: '10px' },
                                    children: () => [{
                                        div: {
                                            children: () => [{
                                                strong: { text: 'Remote Sync Status: ' }
                                            }, {
                                                span: { 
                                                    text: syncEnabled ? 'üü¢ Enabled' : 'üî¥ Disabled',
                                                    style: { marginRight: '15px' }
                                                }
                                            }, {
                                                span: { 
                                                    text: `Last sync: ${lastSyncText}`,
                                                    style: { color: '#666', fontSize: '14px' }
                                                }
                                            }]
                                        }
                                    }, {
                                        div: {
                                            style: { display: 'flex', gap: '10px', flexWrap: 'wrap' },
                                            children: () => [{
                                                button: {
                                                    text: syncEnabled ? 'Disable Sync' : 'Enable Sync',
                                                    className: syncEnabled ? 'filter-button' : 'filter-button active',
                                                    onClick: () => {
                                                        const newState = !syncEnabled;
                                                        services.remoteSyncService.setEnabled(newState, { getState, setState });
                                                    }
                                                }
                                            }, {
                                                button: {
                                                    text: 'Sync Now',
                                                    className: 'filter-button',
                                                    disabled: !syncEnabled,
                                                    onClick: async () => {
                                                        const result = await services.remoteSyncService.sync({ getState, setState }, true);
                                                        if (result.success) {
                                                            services.remoteSyncService.showSyncNotification('Manual sync completed');
                                                        } else {
                                                            services.remoteSyncService.showSyncNotification('Sync failed: ' + (result.error || 'Unknown error'), 'error');
                                                        }
                                                    }
                                                }
                                            }, {
                                                button: {
                                                    text: 'Push to Server',
                                                    className: 'filter-button',
                                                    onClick: async () => {
                                                        const result = await services.remoteSyncService.pushToServer({ getState }, true);
                                                        if (result.success) {
                                                            services.remoteSyncService.showSyncNotification('Data pushed to server');
                                                        } else {
                                                            services.remoteSyncService.showSyncNotification('Push failed: ' + (result.error || 'Unknown error'), 'error');
                                                        }
                                                    }
                                                }
                                            }, {
                                                button: {
                                                    text: 'Pull from Server',
                                                    className: 'filter-button',
                                                    onClick: async () => {
                                                        const result = await services.remoteSyncService.pullFromServer({ getState, setState }, true);
                                                        if (result.success) {
                                                            services.remoteSyncService.showSyncNotification('Data pulled from server');
                                                        } else {
                                                            services.remoteSyncService.showSyncNotification('Pull failed: ' + (result.error || 'Unknown error'), 'error');
                                                        }
                                                    }
                                                }
                                            }]
                                        }
                                    }]
                                }
                            }, {
                                div: {
                                    style: { marginTop: '10px', fontSize: '12px', color: '#666' },
                                    text: syncEnabled ? 
                                        `Auto-sync every ${services.remoteSyncService.config.syncInterval / 1000}s` : 
                                        'Configure your PHP backend endpoint in services.remoteSyncService.config.baseUrl'
                                }
                            }];
                        }
                    }
                }),
                    
                    addTodo: (todo, { setState, getState }) => {
                        const todos = getState('todos', []);
                        setState('todos', [...todos, todo]);
                        setState('router.hasUnsavedChanges', true);
                    },
                    
                    updateTodo: (todoId, updates, { setState, getState }) => {
                        const todos = getState('todos', []);
                        const updatedTodos = todos.map(todo => 
                            todo.id === todoId ? { ...todo, ...updates } : todo
                        );
                        setState('todos', updatedTodos);
                        setState('router.hasUnsavedChanges', true);
                    },
                    
                    deleteTodo: (todoId, { setState, getState }) => {
                        const todos = getState('todos', []);
                        const filteredTodos = todos.filter(todo => todo.id !== todoId);
                        setState('todos', filteredTodos);
                        setState('router.hasUnsavedChanges', true);
                    },
                    
                    clearCompleted: ({ setState, getState }) => {
                        const todos = getState('todos', []);
                        const activeTodos = todos.filter(todo => !todo.completed);
                        setState('todos', activeTodos);
                        setState('router.hasUnsavedChanges', true);
                    },
                    
                    saveTodos: ({ setState, getState }) => {
                        console.log('Saving todos...');
                        // Simulate save
                        setTimeout(() => {
                            setState('router.hasUnsavedChanges', false);
                            alert('Todos saved!');
                        }, 500);
                    },
                    
                    loadTodos: () => {
                        return Promise.resolve([
                            { id: 1, text: 'Learn Juris Framework', completed: true, createdAt: new Date().toISOString() },
                            { id: 2, text: 'Build a todo app', completed: false, createdAt: new Date().toISOString() },
                            { id: 3, text: 'Add routing with guards', completed: false, createdAt: new Date().toISOString() }
                        ]);
                    }
                },
                
                authService: {
                    login: (username, password, { setState }) => {
                        // Simulate login
                        if (username && password) {
                            setState('user.isAuthenticated', true);
                            setState('user.username', username);
                            setState('user.isAdmin', username === 'admin');
                            setState('user.hasProfile', username !== 'newuser');
                            return true;
                        }
                        return false;
                    },
                    
                    logout: ({ setState }) => {
                        setState('user.isAuthenticated', false);
                        setState('user.username', '');
                        setState('user.isAdmin', false);
                        setState('user.hasProfile', false);
                    }
                },
                
                // Remote sync service for PHP backend
                remoteSyncService: {
                    // Configuration
                    config: {
                        baseUrl: '/api',  // Change this to your PHP backend URL
                        endpoints: {
                            sync: '/sync.php',
                            pull: '/pull.php',
                            push: '/push.php'
                        },
                        syncInterval: 30000, // 30 seconds
                        enabled: false, // Set to true to enable remote sync
                        retryAttempts: 3,
                        retryDelay: 2000
                    },
                    
                    // Get user session ID for syncing
                    getSessionId: ({ getState }) => {
                        const username = getState('user.username', '');
                        return username ? `user_${username}` : 'anonymous';
                    },
                    
                    // Push local state to server
                    pushToServer: async function({ getState }, force = false) {
                        if (!this.config.enabled && !force) return { success: false, reason: 'Remote sync disabled' };
                        
                        try {
                            const sessionId = this.getSessionId({ getState });
                            const syncData = {
                                todos: getState('todos', []),
                                user: getState('user', {}),
                                filter: getState('filter', 'all'),
                                timestamp: Date.now()
                            };
                            
                            console.log('üì§ Pushing to server...', syncData);
                            
                            const response = await fetch(`${this.config.baseUrl}${this.config.endpoints.push}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    sessionId,
                                    data: syncData
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            
                            const result = await response.json();
                            console.log('‚úÖ Push successful:', result);
                            return { success: true, data: result };
                            
                        } catch (error) {
                            console.error('‚ùå Push failed:', error);
                            return { success: false, error: error.message };
                        }
                    },
                    
                    // Pull remote state from server
                    pullFromServer: async function({ getState, setState }, force = false) {
                        if (!this.config.enabled && !force) return { success: false, reason: 'Remote sync disabled' };
                        
                        try {
                            const sessionId = this.getSessionId({ getState });
                            
                            console.log('üì• Pulling from server...');
                            
                            const response = await fetch(`${this.config.baseUrl}${this.config.endpoints.pull}?sessionId=${sessionId}`);
                            
                            if (!response.ok) {
                                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                            }
                            
                            const result = await response.json();
                            
                            if (result.success && result.data) {
                                const serverData = result.data;
                                const localTimestamp = getState('sync.lastSync', 0);
                                
                                // Only update if server data is newer
                                if (serverData.timestamp > localTimestamp) {
                                    console.log('üîÑ Applying server updates:', serverData);
                                    
                                    // Update state with remote data
                                    setState('todos', serverData.todos || [], { skipPersist: false, remoteSync: true });
                                    setState('user', { ...getState('user', {}), ...serverData.user }, { skipPersist: false, remoteSync: true });
                                    setState('filter', serverData.filter || 'all', { skipPersist: false, remoteSync: true });
                                    setState('sync.lastSync', serverData.timestamp, { skipPersist: true });
                                    
                                    this.showSyncNotification('Data synced from server');
                                }
                            }
                            
                            console.log('‚úÖ Pull successful:', result);
                            return { success: true, data: result };
                            
                        } catch (error) {
                            console.error('‚ùå Pull failed:', error);
                            return { success: false, error: error.message };
                        }
                    },
                    
                    // Bidirectional sync
                    sync: async function(context, force = false) {
                        if (!this.config.enabled && !force) return { success: false, reason: 'Remote sync disabled' };
                        
                        try {
                            // First pull to get latest server state
                            const pullResult = await this.pullFromServer(context, force);
                            
                            // Then push our current state
                            const pushResult = await this.pushToServer(context, force);
                            
                            return {
                                success: pullResult.success && pushResult.success,
                                pull: pullResult,
                                push: pushResult
                            };
                            
                        } catch (error) {
                            console.error('‚ùå Sync failed:', error);
                            return { success: false, error: error.message };
                        }
                    },
                    
                    // Start automatic syncing
                    startAutoSync: function(context) {
                        if (!this.config.enabled) {
                            console.log('‚è∏Ô∏è Remote sync is disabled');
                            return;
                        }
                        
                        if (this.syncInterval) {
                            clearInterval(this.syncInterval);
                        }
                        
                        console.log(`üîÑ Starting auto-sync every ${this.config.syncInterval}ms`);
                        
                        this.syncInterval = setInterval(async () => {
                            await this.sync(context);
                        }, this.config.syncInterval);
                        
                        // Initial sync
                        setTimeout(() => this.sync(context), 1000);
                    },
                    
                    // Stop automatic syncing
                    stopAutoSync: function() {
                        if (this.syncInterval) {
                            clearInterval(this.syncInterval);
                            this.syncInterval = null;
                            console.log('‚èπÔ∏è Auto-sync stopped');
                        }
                    },
                    
                    // Show sync notification
                    showSyncNotification: function(message, type = 'info') {
                        let notification = document.getElementById('remote-sync-notification');
                        if (!notification) {
                            notification = document.createElement('div');
                            notification.id = 'remote-sync-notification';
                            notification.style.cssText = `
                                position: fixed;
                                top: 70px;
                                right: 20px;
                                background: ${type === 'error' ? '#f44336' : '#4CAF50'};
                                color: white;
                                padding: 12px 20px;
                                border-radius: 8px;
                                font-size: 14px;
                                z-index: 10000;
                                opacity: 0;
                                transition: opacity 0.3s ease;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                            `;
                            document.body.appendChild(notification);
                        }
                        
                        notification.textContent = `‚òÅÔ∏è ${message}`;
                        notification.style.opacity = '1';
                        
                        setTimeout(() => {
                            notification.style.opacity = '0';
                            setTimeout(() => {
                                if (notification.parentNode) {
                                    notification.parentNode.removeChild(notification);
                                }
                            }, 300);
                        }, 3000);
                    },
                    
                    // Enable/disable remote sync
                    setEnabled: function(enabled, context) {
                        this.config.enabled = enabled;
                        
                        if (enabled) {
                            console.log('‚úÖ Remote sync enabled');
                            this.startAutoSync(context);
                        } else {
                            console.log('‚ùå Remote sync disabled');
                            this.stopAutoSync();
                        }
                    }
                }
            },
            
            components: {
                Navigation: (props, { getState, navigate }) => ({
                    div: {
                        className: 'navigation',
                        children: () => {
                            const isAuthenticated = getState('user.isAuthenticated', false);
                            const isAdmin = getState('user.isAdmin', false);
                            const currentRoute = getState('router.currentRoute', '/');
                            
                            const navItems = [{
                                button: {
                                    text: 'Home',
                                    className: currentRoute === '/' ? 'nav-button active' : 'nav-button',
                                    onClick: () => navigate('/')
                                }
                            }];
                            
                            if (isAuthenticated) {
                                navItems.push({
                                    button: {
                                        text: 'Statistics',
                                        className: currentRoute === '/stats' ? 'nav-button active' : 'nav-button',
                                        onClick: () => navigate('/stats')
                                    }
                                });
                                
                                navItems.push({
                                    button: {
                                        text: 'Profile',
                                        className: currentRoute === '/profile' ? 'nav-button active' : 'nav-button',
                                        onClick: () => navigate('/profile')
                                    }
                                });
                                
                                if (isAdmin) {
                                    navItems.push({
                                        button: {
                                            text: 'Admin',
                                            className: currentRoute === '/admin' ? 'nav-button active' : 'nav-button',
                                            onClick: () => navigate('/admin')
                                        }
                                    });
                                }
                                
                                navItems.push({
                                    button: {
                                        text: `Logout (${getState('user.username')})`,
                                        className: 'nav-button',
                                        onClick: (e, { services, navigate, setState }) => {
                                            services.authService.logout({ setState });
                                            navigate('/');
                                        }
                                    }
                                });
                            } else {
                                navItems.push({
                                    button: {
                                        text: 'Login',
                                        className: currentRoute === '/login' ? 'nav-button active' : 'nav-button',
                                        onClick: () => navigate('/login')
                                    }
                                });
                            }
                            
                            return navItems;
                        }
                    }
                }),
                
                HomePage: (props, { getState, setState, services }) => ({
                    div: {
                        children: () => [{
                            div: {
                                className: 'route-info',
                                text: () => {
                                    const params = getState('router.params', {});
                                    const hasUnsaved = getState('router.hasUnsavedChanges', false);
                                    return `Route: / | Params: ${JSON.stringify(params)} | Unsaved: ${hasUnsaved}`;
                                }
                            }
                        }, {
                            SyncStatus: {}
                        }, {
                            TodoForm: {}
                        }, {
                            TodoStats: {}
                        }, {
                            TodoFilters: {}
                        }, {
                            TodoList: {}
                        }, {
                            div: {
                                style: { textAlign: 'center', marginTop: '20px' },
                                children: () => getState('router.hasUnsavedChanges', false) ? [{
                                    button: {
                                        text: 'Save Changes',
                                        className: 'add-button',
                                        onClick: () => services.todoService.saveTodos({ setState, getState })
                                    }
                                }] : []
                            }
                        }]
                    }
                }),
                
                StatsPage: (props, { getState }) => ({
                    div: {
                        children: () => [{
                            div: {
                                className: 'route-info',
                                text: () => {
                                    const params = getState('router.params', {});
                                    return `Route: /stats | Params: ${JSON.stringify(params)} | Auth Required: ‚úÖ`;
                                }
                            }
                        }, {
                            h2: { 
                                text: 'üìä Detailed Statistics',
                                style: { textAlign: 'center', marginBottom: '20px' }
                            }
                        }, {
                            TodoStats: {}
                        }, {
                            div: {
                                style: { marginTop: '30px', padding: '20px', background: '#f9f9f9', borderRadius: '10px' },
                                children: () => [{
                                    h3: { text: 'Analysis' }
                                }, {
                                    p: { 
                                        text: () => {
                                            const todos = getState('todos', []);
                                            const completedToday = todos.filter(t => 
                                                t.completed && 
                                                new Date(t.createdAt).toDateString() === new Date().toDateString()
                                            ).length;
                                            return `Completed today: ${completedToday}`;
                                        }
                                    }
                                }]
                            }
                        }]
                    }
                }),
                
                AdminPage: (props, { getState }) => ({
                    div: {
                        children: () => [{
                            div: {
                                className: 'route-info',
                                text: () => {
                                    const params = getState('router.params', {});
                                    return `Route: /admin | Params: ${JSON.stringify(params)} | Auth + Admin Required: ‚úÖ`;
                                }
                            }
                        }, {
                            h2: { 
                                text: 'üîê Admin Dashboard',
                                style: { textAlign: 'center', marginBottom: '20px' }
                            }
                        }, {
                            div: {
                                className: 'stats',
                                children: () => {
                                    const adminData = getState('adminData', {});
                                    return [{
                                        div: {
                                            className: 'stat-item',
                                            children: () => [{
                                                div: { className: 'stat-number', text: (adminData.users || 0).toString() }
                                            }, {
                                                div: { className: 'stat-label', text: 'Total Users' }
                                            }]
                                        }
                                    }, {
                                        div: {
                                            className: 'stat-item',
                                            children: () => [{
                                                div: { className: 'stat-number', text: (adminData.todos || 0).toString() }
                                            }, {
                                                div: { className: 'stat-label', text: 'Total Todos' }
                                            }]
                                        }
                                    }];
                                }
                            }
                        }, {
                            p: {
                                text: () => {
                                    const adminData = getState('adminData', {});
                                    return adminData.lastUpdate ? 
                                        `Last updated: ${new Date(adminData.lastUpdate).toLocaleString()}` :
                                        'Loading...';
                                },
                                style: { textAlign: 'center', marginTop: '20px', color: '#666' }
                            }
                        }]
                    }
                }),
                
                ProfilePage: (props, { getState }) => ({
                    div: {
                        children: () => [{
                            div: {
                                className: 'route-info',
                                text: () => {
                                    const params = getState('router.params', {});
                                    return `Route: /profile | Params: ${JSON.stringify(params)} | Auth + Profile Required: ‚úÖ`;
                                }
                            }
                        }, {
                            h2: { 
                                text: 'üë§ User Profile',
                                style: { textAlign: 'center', marginBottom: '20px' }
                            }
                        }, {
                            div: {
                                style: { padding: '20px', background: '#f9f9f9', borderRadius: '10px' },
                                children: () => [{
                                    p: { text: () => `Username: ${getState('user.username', 'Unknown')}` }
                                }, {
                                    p: { text: () => `Admin: ${getState('user.isAdmin', false) ? 'Yes' : 'No'}` }
                                }, {
                                    p: { text: () => `Profile Complete: ${getState('user.hasProfile', false) ? 'Yes' : 'No'}` }
                                }]
                            }
                        }]
                    }
                }),
                
                UserPage: (props, { getState }) => ({
                    div: {
                        children: () => [{
                            div: {
                                className: 'route-info',
                                text: () => {
                                    const params = getState('router.params', {});
                                    return `Route: /user/:id | Params: ${JSON.stringify(params)} | Data Loading Demo`;
                                }
                            }
                        }, {
                            h2: { 
                                text: () => {
                                    const user = getState('currentUser', {});
                                    return user.name ? `üë§ ${user.name}` : 'Loading User...';
                                },
                                style: { textAlign: 'center', marginBottom: '20px' }
                            }
                        }, {
                            div: {
                                style: { padding: '20px', background: '#f9f9f9', borderRadius: '10px' },
                                children: () => {
                                    const user = getState('currentUser', {});
                                    if (!user.id) {
                                        return [{ p: { text: 'Loading user data...' } }];
                                    }
                                    return [{
                                        p: { text: `User ID: ${user.id}` }
                                    }, {
                                        p: { text: `Name: ${user.name}` }
                                    }, {
                                        p: { text: `Todo Count: ${user.todos}` }
                                    }];
                                }
                            }
                        }]
                    }
                }),
                
                LoginPage: (props, { setState, services, navigate }) => ({
                    div: {
                        children: () => [{
                            h2: { 
                                text: 'üîê Login',
                                style: { textAlign: 'center', marginBottom: '20px' }
                            }
                        }, {
                            div: {
                                className: 'auth-form',
                                children: () => [{
                                    input: {
                                        type: 'text',
                                        placeholder: 'Username (try: admin, user, newuser)',
                                        id: 'username'
                                    }
                                }, {
                                    input: {
                                        type: 'password',
                                        placeholder: 'Password (any)',
                                        id: 'password'
                                    }
                                }, {
                                    button: {
                                        text: 'Login',
                                        onClick: () => {
                                            const username = document.getElementById('username').value;
                                            const password = document.getElementById('password').value;
                                            
                                            if (services.authService.login(username, password, { setState })) {
                                                navigate('/');
                                            } else {
                                                alert('Please enter username and password');
                                            }
                                        }
                                    }
                                }]
                            }
                        }, {
                            div: {
                                style: { marginTop: '20px', padding: '15px', background: '#e3f2fd', borderRadius: '5px' },
                                children: () => [{
                                    h4: { text: 'Demo Accounts:' }
                                }, {
                                    p: { text: '‚Ä¢ admin (has admin access)' }
                                }, {
                                    p: { text: '‚Ä¢ user (regular user with profile)' }
                                }, {
                                    p: { text: '‚Ä¢ newuser (no profile, will block /profile route)' }
                                }]
                            }
                        }]
                    }
                }),
                
                UnauthorizedPage: (props, { navigate }) => ({
                    div: {
                        className: 'unauthorized',
                        children: () => [{
                            h2: { text: 'üö´ Unauthorized' }
                        }, {
                            p: { text: 'You do not have permission to access this page.' }
                        }, {
                            button: {
                                text: 'Go Home',
                                onClick: () => navigate('/')
                            }
                        }]
                    }
                }),
                
                // Todo components (unchanged)
                TodoForm: (props, { setState, getState, services }) => ({
                    div: {
                        className: 'todo-form',
                        children: () => [{
                            input: {
                                type: 'text',
                                className: 'todo-input',
                                placeholder: 'What needs to be done?',
                                value: () => getState('newTodoText', ''),
                                onInput: (e, { setState }) => {
                                    setState('newTodoText', e.target.value);
                                },
                                onKeyPress: (e, { setState, getState, services }) => {
                                    if (e.key === 'Enter') {
                                        const text = getState('newTodoText', '').trim();
                                        if (text) {
                                            const newTodo = services.todoService.createTodo(text);
                                            services.todoService.addTodo(newTodo, { setState, getState });
                                            setState('newTodoText', '');
                                        }
                                    }
                                }
                            }
                        }, {
                            button: {
                                className: 'add-button',
                                text: 'Add Todo',
                                onClick: (e, { setState, getState, services }) => {
                                    const text = getState('newTodoText', '').trim();
                                    if (text) {
                                        const newTodo = services.todoService.createTodo(text);
                                        services.todoService.addTodo(newTodo, { setState, getState });
                                        setState('newTodoText', '');
                                    }
                                }
                            }
                        }]
                    }
                }),
                
                TodoFilters: (props, { setState, getState, services }) => ({
                    div: {
                        className: 'filters',
                        children: () => [{
                            button: {
                                className: () => getState('filter') === 'all' ? 'filter-button active' : 'filter-button',
                                text: 'All',
                                onClick: () => setState('filter', 'all')
                            }
                        }, {
                            button: {
                                className: () => getState('filter') === 'active' ? 'filter-button active' : 'filter-button',
                                text: 'Active',
                                onClick: () => setState('filter', 'active')
                            }
                        }, {
                            button: {
                                className: () => getState('filter') === 'completed' ? 'filter-button active' : 'filter-button',
                                text: 'Completed',
                                onClick: () => setState('filter', 'completed')
                            }
                        }, {
                            button: {
                                className: 'clear-completed',
                                text: 'Clear Completed',
                                disabled: () => {
                                    const todos = getState('todos', []);
                                    return !todos.some(todo => todo.completed);
                                },
                                onClick: (e, { setState, getState, services }) => {
                                    services.todoService.clearCompleted({ setState, getState });
                                }
                            }
                        }]
                    }
                }),
                
                TodoItem: (props, { setState, getState, services }) => {
                    const todo = props.todo;
                    
                    return {
                        div: {
                            className: () => {
                                let classes = 'todo-item';
                                if (todo.completed) classes += ' completed';
                                if (getState('editingId') === todo.id) classes += ' editing';
                                return classes;
                            },
                            children: () => {
                                const isEditing = getState('editingId') === todo.id;
                                
                                return isEditing ? [
                                    {
                                        input: {
                                            type: 'text',
                                            className: 'todo-edit-input',
                                            value: () => getState('editText', ''),
                                            onInput: (e, { setState }) => {
                                                setState('editText', e.target.value);
                                            },
                                            onKeyPress: (e, { setState, getState, services }) => {
                                                if (e.key === 'Enter') {
                                                    const newText = getState('editText', '').trim();
                                                    if (newText) {
                                                        services.todoService.updateTodo(todo.id, { text: newText }, { setState, getState });
                                                    }
                                                    setState('editingId', null);
                                                    setState('editText', '');
                                                } else if (e.key === 'Escape') {
                                                    setState('editingId', null);
                                                    setState('editText', '');
                                                }
                                            }
                                        }
                                    },
                                    {
                                        div: {
                                            className: 'todo-actions',
                                            children: () => [{
                                                button: {
                                                    className: 'action-button save-button',
                                                    text: 'Save',
                                                    onClick: (e, { setState, getState, services }) => {
                                                        const newText = getState('editText', '').trim();
                                                        if (newText) {
                                                            services.todoService.updateTodo(todo.id, { text: newText }, { setState, getState });
                                                        }
                                                        setState('editingId', null);
                                                        setState('editText', '');
                                                    }
                                                }
                                            }, {
                                                button: {
                                                    className: 'action-button cancel-button',
                                                    text: 'Cancel',
                                                    onClick: (e, { setState }) => {
                                                        setState('editingId', null);
                                                        setState('editText', '');
                                                    }
                                                }
                                            }]
                                        }
                                    }
                                ] : [
                                    {
                                        input: {
                                            type: 'checkbox',
                                            className: 'todo-checkbox',
                                            checked: todo.completed,
                                            onChange: (e, { setState, getState, services }) => {
                                                services.todoService.updateTodo(todo.id, { completed: !todo.completed }, { setState, getState });
                                            }
                                        }
                                    },
                                    {
                                        span: {
                                            className: todo.completed ? 'todo-text completed' : 'todo-text',
                                            text: todo.text,
                                            onClick: (e, { setState }) => {
                                                setState('editingId', todo.id);
                                                setState('editText', todo.text);
                                            }
                                        }
                                    },
                                    {
                                        div: {
                                            className: 'todo-actions',
                                            children: () => [{
                                                button: {
                                                    className: 'action-button edit-button',
                                                    text: 'Edit',
                                                    onClick: (e, { setState }) => {
                                                        setState('editingId', todo.id);
                                                        setState('editText', todo.text);
                                                    }
                                                }
                                            }, {
                                                button: {
                                                    className: 'action-button delete-button',
                                                    text: 'Delete',
                                                    onClick: (e, { setState, getState, services }) => {
                                                        services.todoService.deleteTodo(todo.id, { setState, getState });
                                                    }
                                                }
                                            }]
                                        }
                                    }
                                ];
                            }
                        }
                    };
                },
                
                TodoList: (props, { getState }) => ({
                    div: {
                        children: () => {
                            const todos = getState('todos', []);
                            const filter = getState('filter', 'all');
                            
                            const filteredTodos = todos.filter(todo => {
                                if (filter === 'all') return true;
                                if (filter === 'active') return !todo.completed;
                                if (filter === 'completed') return todo.completed;
                                return true;
                            });
                            
                            if (filteredTodos.length === 0) {
                                return [{
                                    div: {
                                        className: 'empty-state',
                                        children: () => [{
                                            h3: { 
                                                text: () => {
                                                    const filter = getState('filter', 'all');
                                                    if (filter === 'active') return 'No active todos';
                                                    if (filter === 'completed') return 'No completed todos';
                                                    return 'No todos yet';
                                                }
                                            }
                                        }, {
                                            p: { 
                                                text: () => {
                                                    const filter = getState('filter', 'all');
                                                    if (filter === 'active') return 'Great job! All tasks are completed.';
                                                    if (filter === 'completed') return 'Complete some todos to see them here.';
                                                    return 'Add your first todo above to get started.';
                                                }
                                            }
                                        }]
                                    }
                                }];
                            }
                            
                            return filteredTodos.map(todo => ({
                                TodoItem: { todo }
                            }));
                        }
                    }
                }),
                
                TodoStats: (props, { getState }) => ({
                    div: {
                        className: 'stats',
                        children: () => {
                            const todos = getState('todos', []);
                            const totalCount = todos.length;
                            const activeCount = todos.filter(todo => !todo.completed).length;
                            const completedCount = todos.filter(todo => todo.completed).length;
                            const completionRate = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                            
                            return [{
                                div: {
                                    className: 'stat-item',
                                    children: () => [{
                                        div: { 
                                            className: 'stat-number', 
                                            text: totalCount.toString()
                                        }
                                    }, {
                                        div: { className: 'stat-label', text: 'Total' }
                                    }]
                                }
                            }, {
                                div: {
                                    className: 'stat-item',
                                    children: () => [{
                                        div: { 
                                            className: 'stat-number', 
                                            text: activeCount.toString()
                                        }
                                    }, {
                                        div: { className: 'stat-label', text: 'Active' }
                                    }]
                                }
                            }, {
                                div: {
                                    className: 'stat-item',
                                    children: () => [{
                                        div: { 
                                            className: 'stat-number', 
                                            text: completedCount.toString()
                                        }
                                    }, {
                                        div: { className: 'stat-label', text: 'Completed' }
                                    }]
                                }
                            }, {
                                div: {
                                    className: 'stat-item',
                                    children: () => [{
                                        div: { 
                                            className: 'stat-number', 
                                            text: `${completionRate}%`
                                        }
                                    }, {
                                        div: { className: 'stat-label', text: 'Complete' }
                                    }]
                                }
                            }];
                        }
                    }
                })
            },
            
            layout: {
                div: {
                    children: () => [{
                        Navigation: {}
                    }, {
                        Router: {}
                    }]
                }
            }
        });
        
        // Restore state from localStorage
        function restoreFromLocalStorage() {
            const persistPaths = ['todos', 'user', 'filter'];
            
            persistPaths.forEach(path => {
                try {
                    if (typeof Storage !== 'undefined') {
                        const stored = localStorage.getItem(`juris_${path}`);
                        if (stored) {
                            const parsedValue = JSON.parse(stored);
                            // Use skipPersist context to avoid re-saving during restoration
                            app.setState(path, parsedValue, { skipPersist: true });
                            console.log(`üîÑ Restored ${path} from localStorage:`, parsedValue);
                        }
                    }
                } catch (error) {
                    console.error(`Error restoring ${path} from localStorage:`, error);
                }
            });
        }
        
        // Cross-tab synchronization
        function setupCrossTabSync() {
            if (typeof Storage !== 'undefined') {
                window.addEventListener('storage', (e) => {
                    // Only handle our juris keys
                    if (e.key && e.key.startsWith('juris_') && e.newValue !== null) {
                        try {
                            const path = e.key.replace('juris_', '');
                            const newValue = JSON.parse(e.newValue);
                            const currentValue = app.getState(path);
                            
                            // Only update if the value actually changed
                            if (JSON.stringify(currentValue) !== JSON.stringify(newValue)) {
                                console.log(`üîÑ Cross-tab sync: ${path}`, newValue);
                                // Use skipPersist to avoid triggering localStorage write
                                app.setState(path, newValue, { skipPersist: true, crossTabSync: true });
                                
                                // Show notification for cross-tab updates
                                showCrossTabNotification(path);
                            }
                        } catch (error) {
                            console.error('Cross-tab sync error:', error);
                        }
                    }
                    
                    // Handle localStorage clear events
                    if (e.key && e.key.startsWith('juris_') && e.newValue === null) {
                        const path = e.key.replace('juris_', '');
                        console.log(`üóëÔ∏è Cross-tab clear: ${path}`);
                        
                        // Reset to default value
                        const defaultValues = {
                            todos: [],
                            user: {
                                isAuthenticated: false,
                                isAdmin: false,
                                username: '',
                                hasProfile: false
                            },
                            filter: 'all'
                        };
                        
                        if (defaultValues[path]) {
                            app.setState(path, defaultValues[path], { skipPersist: true, crossTabSync: true });
                            showCrossTabNotification(path, 'cleared');
                        }
                    }
                });
                
                console.log('üîÑ Cross-tab synchronization enabled');
            }
        }
        
        // Show cross-tab notification
        function showCrossTabNotification(path, action = 'updated') {
            // Create or update notification element
            let notification = document.getElementById('cross-tab-notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'cross-tab-notification';
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #2196F3;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    z-index: 10000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                `;
                document.body.appendChild(notification);
            }
            
            // Update notification content
            const pathDisplayName = {
                todos: 'Todos',
                user: 'User data',
                filter: 'Filter'
            }[path] || path;
            
            notification.textContent = `üì± ${pathDisplayName} ${action} in another tab`;
            notification.style.opacity = '1';
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
        
        // Restore state on app initialization
        restoreFromLocalStorage();
        
        // Setup cross-tab synchronization
        setupCrossTabSync();
        
        // Load initial todos only if not restored from localStorage
        if (app.getState('todos', []).length === 0) {
            app.services.todoService.loadTodos().then(todos => {
                app.setState('todos', todos);
            });
        }
        
        // Initialize remote sync service
        app.services.remoteSyncService.startAutoSync({ 
            getState: (path, defaultValue) => app.getState(path, defaultValue),
            setState: (path, value, context) => app.setState(path, value, context)
        });
        
        // External state subscriptions for debugging
        app.subscribe('todos', (newTodos, oldTodos) => {
            console.log(`Todos updated: ${newTodos.length} total`);
        });
        
        app.subscribe('router.currentRoute', (newRoute) => {
            console.log(`Route changed to: ${newRoute}`);
        });
        
        app.subscribe('user.isAuthenticated', (isAuth) => {
            console.log(`Authentication status: ${isAuth}`);
        });
        
        // Initial render
        app.render('#app');
        
        // Expose app for debugging
        window.app = app;
        
        // Demo navigation buttons for testing
        console.log('Demo commands:');
        console.log('app.navigate("/user/123") - Test parameterized route');
        console.log('app.setState("router.hasUnsavedChanges", true) - Test unsaved changes guard');
        console.log('app.clearLocalStorage() - Clear all persisted data');
        console.log('üí° Open multiple tabs to test cross-tab synchronization!');
        console.log('üí° Changes in one tab will automatically sync to all other tabs');
        console.log('');
        console.log('üåê Remote Sync Commands:');
        console.log('app.services.remoteSyncService.setEnabled(true, { getState: app.getState.bind(app), setState: app.setState.bind(app) }) - Enable remote sync');
        console.log('app.services.remoteSyncService.config.baseUrl = "https://your-api.com" - Set your PHP backend URL');
        console.log('app.services.remoteSyncService.sync({ getState: app.getState.bind(app), setState: app.setState.bind(app) }, true) - Manual sync');
        
        // Add helper method to clear localStorage
        app.clearLocalStorage = function() {
            const persistPaths = ['todos', 'user', 'filter'];
            persistPaths.forEach(path => {
                if (typeof Storage !== 'undefined') {
                    localStorage.removeItem(`juris_${path}`);
                    console.log(`üóëÔ∏è Cleared ${path} from localStorage`);
                }
            });
            
            // Reset to initial state
            this.setState('todos', [], { skipPersist: true });
            this.setState('user', {
                isAuthenticated: false,
                isAdmin: false,
                username: '',
                hasProfile: false
            }, { skipPersist: true });
            this.setState('filter', 'all', { skipPersist: true });
            
            // Reload initial todos
            this.services.todoService.loadTodos().then(todos => {
                this.setState('todos', todos);
            });
            
            console.log('üîÑ State reset to initial values');
        };
    </script>
</body>
</html>