<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TodoMaster - JurisJS Complete Demo</title>
    <link rel="stylesheet" href="styles/footer.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            line-height: 1.6;
            color: #e2e8f0;
            background: #0f172a;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #7c3aed;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
            align-items: center;
        }

        .nav-links a {
            color: #cbd5e1;
            text-decoration: none;
            transition: color 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        .nav-links a:hover,
        .nav-links a.active {
            color: #7c3aed;
            background: rgba(124, 58, 237, 0.1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #7c3aed, #3b82f6);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.1);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        /* Main Content */
        .main-content {
            margin-top: 80px;
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        .page-content {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 2rem;
            min-height: 500px;
            backdrop-filter: blur(10px);
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            color: #ffffff;
            background: linear-gradient(135deg, #ffffff, #c4b5fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-subtitle {
            color: #94a3b8;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 2rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #c4b5fd;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control::placeholder {
            color: #94a3b8;
        }

        .form-control:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .success-message {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* Todo App Styles */
        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .todo-stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(124, 58, 237, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            border: 1px solid rgba(124, 58, 237, 0.3);
        }

        .stat-number {
            font-weight: 700;
            color: #ffd700;
        }

        .todo-form {
            background: rgba(255, 255, 255, 0.05);
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .todo-form h3 {
            color: #ffd700;
            margin-bottom: 1.5rem;
            font-size: 1.3rem;
        }

        .todo-input-group {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .todo-input {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            font-size: 1rem;
        }

        .todo-input::placeholder {
            color: #94a3b8;
        }

        .todo-input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.2);
        }

        .priority-select, .category-input {
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #ffffff;
            min-width: 120px;
        }

        .priority-select option {
            background: #1e293b;
            color: #ffffff;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-group span {
            font-weight: 600;
            color: #c4b5fd;
            margin-right: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #cbd5e1;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .filter-btn.active {
            background: rgba(124, 58, 237, 0.3);
            color: #ffffff;
            border-color: #7c3aed;
        }

        .search-input {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #ffffff;
            min-width: 200px;
        }

        .search-input::placeholder {
            color: #94a3b8;
        }

        /* Todo List - FIXED LAYOUT */
        .todo-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .todo-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .todo-item:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(124, 58, 237, 0.3);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .todo-item.completed {
            opacity: 0.6;
            background: rgba(255, 255, 255, 0.02);
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: #94a3b8;
        }

        /* FIXED: Proper layout for todo content */
        .todo-content {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 1rem;
            align-items: start;
            width: 100%;
        }

        .todo-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #7c3aed;
            margin-top: 0.25rem;
            flex-shrink: 0;
        }

        /* FIXED: Todo details take up the middle space */
        .todo-details {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-width: 0; /* Allow text to wrap */
            flex: 1;
        }

        .todo-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: #e2e8f0;
            line-height: 1.4;
            word-wrap: break-word;
        }

        /* FIXED: Better meta layout */
        .todo-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .priority {
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .priority-high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .priority-medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .priority-low {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .category {
            background: rgba(124, 58, 237, 0.2);
            color: #c4b5fd;
            padding: 0.25rem 0.6rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid rgba(124, 58, 237, 0.3);
            white-space: nowrap;
        }

        .todo-date {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        /* FIXED: Actions positioned on the right */
        .todo-actions {
            display: flex;
            gap: 0.5rem;
            align-items: flex-start;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #94a3b8;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state h3 {
            color: #c4b5fd;
            margin-bottom: 0.5rem;
        }

        /* Sync Status */
        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            color: #e2e8f0;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .sync-status.syncing {
            background: rgba(245, 158, 11, 0.9);
            color: #000;
            border-color: rgba(245, 158, 11, 0.5);
        }

        .sync-status.synced {
            background: rgba(34, 197, 94, 0.9);
            color: #000;
            border-color: rgba(34, 197, 94, 0.5);
        }

        .sync-status.error {
            background: rgba(239, 68, 68, 0.9);
            color: #fff;
            border-color: rgba(239, 68, 68, 0.5);
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hero Section */
        .hero-section {
            text-align: center;
            padding: 4rem 0;
            background: radial-gradient(ellipse at center, rgba(124, 58, 237, 0.1) 0%, transparent 70%);
        }

        .hero-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .container {
                padding: 0 15px;
            }
            
            .nav-links {
                gap: 1.5rem;
            }
            
            .btn {
                padding: 0.6rem 1.2rem;
                font-size: 0.85rem;
            }

            .todo-input-group {
                grid-template-columns: 1fr;
            }

            .todo-stats {
                gap: 1rem;
            }
        }

        @media (max-width: 768px) {
            .nav {
                padding: 0.75rem 0;
                flex-wrap: wrap;
            }
            
            .logo {
                font-size: 1.3rem;
                order: 1;
            }
            
            .nav-links {
                display: flex !important;
                gap: 1rem;
                order: 3;
                flex-basis: 100%;
                justify-content: center;
                margin-top: 1rem;
            }
            
            .nav-links a {
                font-size: 0.9rem;
                padding: 0.5rem;
            }

            .main-content {
                margin-top: 120px;
            }

            .page-content {
                padding: 1.5rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .filters {
                flex-direction: column;
                gap: 1rem;
            }

            .filter-group {
                justify-content: center;
            }

            /* FIXED: Mobile layout for todo items */
            .todo-content {
                grid-template-columns: auto 1fr;
                grid-template-rows: auto auto;
                gap: 1rem;
            }

            .todo-checkbox {
                grid-row: 1;
            }

            .todo-details {
                grid-row: 1;
            }

            .todo-actions {
                grid-column: 1 / -1;
                grid-row: 2;
                justify-content: flex-end;
                margin-top: 0.5rem;
            }

            .todo-meta {
                justify-content: flex-start;
                gap: 0.5rem;
            }

            .todo-stats {
                flex-direction: column;
                gap: 0.5rem;
            }

            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        @media (max-width: 480px) {
            .nav-links {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            
            .nav-links a {
                font-size: 0.85rem;
                padding: 0.4rem 0.5rem;
                flex: 1 1 auto;
                text-align: center;
                min-width: 60px;
            }

            .page-content {
                padding: 1rem;
            }

            .todo-form {
                padding: 1.5rem;
            }

            .filters {
                padding: 1rem;
            }

            .todo-item {
                padding: 1rem;
            }
        }

        /* Custom Scrollbars */
        .todo-list::-webkit-scrollbar {
            width: 6px;
        }

        .todo-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .todo-list::-webkit-scrollbar-thumb {
            background: rgba(124, 58, 237, 0.5);
            border-radius: 3px;
        }

        .todo-list::-webkit-scrollbar-thumb:hover {
            background: rgba(124, 58, 237, 0.7);
        }

        body::-webkit-scrollbar {
            width: 12px;
        }

        body::-webkit-scrollbar-track {
            background: #0f172a;
        }

        body::-webkit-scrollbar-thumb {
            background: rgba(124, 58, 237, 0.4);
            border-radius: 6px;
        }

        body::-webkit-scrollbar-thumb:hover {
            background: rgba(124, 58, 237, 0.6);
        }
        #render-time{
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            z-index: 10000;
            padding: 10px;
            border-radius: 5px;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body>
    <h3 id="render-time"></h3>
    <div id="app"></div>
    <footer></footer>
    <!-- Load Juris Framework -->
    <script src="juris.js"></script>

    <script>
        const start = performance.now();
        console.time('juris_todomaster_multiuser_demo');

        // Headless Footer Loader Component using Intersection Observer
        const FooterLoader = (props, context) => {
          let observer = null;
          let isLoaded = false;

          const loadFooterHTML = async () => {
            if (isLoaded) return;
            
            try {
              const response = await fetch('juris-footer.html');
              if (!response.ok) {
                throw new Error(`Failed to load footer: ${response.status} ${response.statusText}`);
              }
              
              const html = await response.text();
              const footerElement = document.querySelector('footer');
              
              if (footerElement) {
                footerElement.innerHTML = html;
                isLoaded = true;
                
                // Disconnect observer after successful load
                if (observer) {
                  observer.disconnect();
                  observer = null;
                }
              }
            } catch (error) {
              console.error('Footer loading failed:', error);
              // Optional: Set error state or retry logic here
              if (props.onError) {
                props.onError(error);
              }
            }
          };

          const setupIntersectionObserver = () => {
            const footerElement = document.querySelector('footer');
            
            if (!footerElement) {
              console.warn('Footer element not found. FooterLoader will not observe.');
              return;
            }

            // Create intersection observer with default options
            const observerOptions = {
              root: null, // viewport
              rootMargin: '0px',
              threshold: 0.1 // Trigger when 10% of footer is visible
            };

            observer = new IntersectionObserver((entries) => {
              entries.forEach((entry) => {
                if (entry.isIntersecting && !isLoaded) {
                  loadFooterHTML();
                }
              });
            }, observerOptions);

            // Start observing the footer
            observer.observe(footerElement);
          };

          return {
            onRegistered: () => {
              // Setup observer when component is registered
              setupIntersectionObserver();
              
              // Return cleanup function
              return () => {
                if (observer) {
                  observer.disconnect();
                  observer = null;
                }
              };
            }
          };
        };
// Mobile Debug Helper
const MobileDebugger = {
    log: (message, data = null) => {
        console.log(`📱 ${message}`, data);
        // Also try to show critical info in UI for mobile debugging
        if (message.includes('ERROR') || message.includes('undefined')) {
            try {
                const debugDiv = document.getElementById('mobile-debug');
                if (debugDiv) {
                    debugDiv.innerHTML += `<div style="color: red; font-size: 12px;">${message}: ${JSON.stringify(data)}</div>`;
                }
            } catch (e) {
                // Ignore if can't create debug output
            }
        }
    },
    
    checkEnvironment: () => {
        const info = {
            userAgent: navigator.userAgent,
            localStorage: typeof(Storage) !== "undefined",
            localStorageTest: false,
            currentUrl: window.location.href,
            timestamp: new Date().toISOString()
        };
        
        // Test localStorage functionality
        try {
            localStorage.setItem('test_mobile', 'test_value');
            const testValue = localStorage.getItem('test_mobile');
            info.localStorageTest = testValue === 'test_value';
            localStorage.removeItem('test_mobile');
        } catch (error) {
            info.localStorageError = error.message;
        }
        
        MobileDebugger.log('Mobile Environment Check', info);
        return info;
    }
};

// Add mobile debug output to DOM
if (typeof document !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
        const debugDiv = document.createElement('div');
        debugDiv.id = 'mobile-debug';
        debugDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; background: rgba(0,0,0,0.8); color: white; padding: 10px; font-size: 10px; z-index: 10000; max-height: 100px; overflow-y: auto; display: none;';
        document.body.appendChild(debugDiv);
        
        // Show debug on triple tap
        let tapCount = 0;
        document.addEventListener('touchstart', () => {
            tapCount++;
            setTimeout(() => tapCount = 0, 1000);
            if (tapCount === 3) {
                debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
            }
        });
    });
}

// Run initial mobile check
MobileDebugger.checkEnvironment();

// =================================================================
// MULTI-USER STORAGE & AUTHENTICATION SYSTEM
// =================================================================

// User Database Service (Simulated)
const UserDatabase = {
    // In a real app, this would be a backend API
    users: (() => {
        try {
            const saved = localStorage.getItem('juris_users_db');
            MobileDebugger.log('Loading users from localStorage', { saved: !!saved });
            return saved ? JSON.parse(saved) : {};
        } catch (error) {
            MobileDebugger.log('ERROR loading users from localStorage', error);
            return {};
        }
    })(),
    
    // Initialize demo users if database is empty
    initializeDemoUsers() {
        MobileDebugger.log('Checking demo user initialization', { 
            currentUserCount: Object.keys(this.users).length 
        });
        
        if (Object.keys(this.users).length === 0) {
            console.log('🎭 Initializing demo users...');
            MobileDebugger.log('Creating demo users');
            
            const demoUsers = [
                {
                    username: 'alice',
                    email: 'alice@demo.com',
                    password: 'demo123',
                    profile: {
                        displayName: 'Alice Johnson',
                        preferences: {
                            defaultCategory: 'work',
                            defaultPriority: 'high'
                        }
                    }
                },
                {
                    username: 'bob',
                    email: 'bob@demo.com',
                    password: 'demo123',
                    profile: {
                        displayName: 'Bob Smith',
                        preferences: {
                            defaultCategory: 'personal',
                            defaultPriority: 'medium'
                        }
                    }
                },
                {
                    username: 'charlie',
                    email: 'charlie@demo.com',
                    password: 'demo123',
                    profile: {
                        displayName: 'Charlie Wilson',
                        preferences: {
                            defaultCategory: 'general',
                            defaultPriority: 'low'
                        }
                    }
                }
            ];
            
            // Create demo users
            demoUsers.forEach((userData, index) => {
                try {
                    const userId = `user_${Date.now()}_${index}_${Math.random().toString(36).substr(2, 9)}`;
                    this.users[userId] = {
                        id: userId,
                        username: userData.username,
                        email: userData.email,
                        password: userData.password,
                        createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                        profile: userData.profile
                    };
                    
                    // Create demo todos for each user
                    this.createDemoTodos(userId, userData.username);
                    MobileDebugger.log(`Created demo user: ${userData.username}`, { userId });
                } catch (error) {
                    MobileDebugger.log(`ERROR creating demo user: ${userData.username}`, error);
                }
            });
            
            this.saveUsers();
            console.log('✅ Demo users created:', Object.values(this.users).map(u => u.username));
            MobileDebugger.log('Demo initialization complete', { 
                userCount: Object.keys(this.users).length 
            });
        } else {
            MobileDebugger.log('Demo users already exist', { 
                userCount: Object.keys(this.users).length,
                usernames: Object.values(this.users).map(u => u.username)
            });
        }
    },
    
    // Create demo todos for a user
    createDemoTodos(userId, username) {
        try {
            const demoTodosData = {
                alice: [
                    { text: 'Finish quarterly report', priority: 'high', category: 'work', completed: false },
                    { text: 'Team meeting at 2 PM', priority: 'high', category: 'work', completed: true },
                    { text: 'Review budget proposal', priority: 'medium', category: 'work', completed: false },
                    { text: 'Call dentist for appointment', priority: 'low', category: 'personal', completed: false },
                    { text: 'Buy groceries', priority: 'medium', category: 'personal', completed: true }
                ],
                bob: [
                    { text: 'Fix the leaky faucet', priority: 'high', category: 'home', completed: false },
                    { text: 'Plan weekend hiking trip', priority: 'medium', category: 'personal', completed: false },
                    { text: 'Read new programming book', priority: 'low', category: 'learning', completed: false },
                    { text: 'Water the plants', priority: 'low', category: 'home', completed: true },
                    { text: 'Update LinkedIn profile', priority: 'medium', category: 'career', completed: false }
                ],
                charlie: [
                    { text: 'Learn Spanish basics', priority: 'medium', category: 'learning', completed: false },
                    { text: 'Organize photo album', priority: 'low', category: 'personal', completed: false },
                    { text: 'Research vacation destinations', priority: 'low', category: 'travel', completed: true },
                    { text: 'Clean garage', priority: 'medium', category: 'home', completed: false }
                ]
            };
            
            const userTodos = demoTodosData[username] || [];
            const todos = userTodos.map((todo, index) => ({
                id: `todo_${userId}_${index}_${Math.random().toString(36).substr(2, 9)}`,
                userId: userId,
                text: todo.text,
                completed: todo.completed,
                priority: todo.priority,
                category: todo.category,
                createdAt: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString(),
                updatedAt: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000).toISOString(),
                createdBy: username
            }));
            
            // Save todos for this user
            localStorage.setItem(`juris_todos_${userId}`, JSON.stringify(todos));
            console.log(`📝 Created ${todos.length} demo todos for ${username}`);
            MobileDebugger.log(`Demo todos created for ${username}`, { 
                todoCount: todos.length,
                userId: userId 
            });
        } catch (error) {
            MobileDebugger.log(`ERROR creating demo todos for ${username}`, error);
        }
    },
    
    saveUsers() {
        try {
            localStorage.setItem('juris_users_db', JSON.stringify(this.users));
            MobileDebugger.log('Users saved successfully', { count: Object.keys(this.users).length });
        } catch (error) {
            MobileDebugger.log('ERROR saving users', error);
        }
    },
    
    createUser(userData) {
        const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        const user = {
            id: userId,
            username: userData.username,
            email: userData.email,
            password: userData.password, // In real app, this would be hashed
            createdAt: new Date().toISOString(),
            profile: {
                displayName: userData.username,
                theme: 'dark',
                preferences: {
                    defaultCategory: 'general',
                    defaultPriority: 'medium'
                }
            }
        };
        
        this.users[userId] = user;
        this.saveUsers();
        return { ...user, password: undefined }; // Don't return password
    },
    
    authenticateUser(username, password) {
        const user = Object.values(this.users).find(u => 
            u.username === username && u.password === password
        );
        
        if (user) {
            return { ...user, password: undefined }; // Don't return password
        }
        return null;
    },
    
    getUserById(userId) {
        const user = this.users[userId];
        return user ? { ...user, password: undefined } : null;
    },
    
    updateUser(userId, updates) {
        if (this.users[userId]) {
            this.users[userId] = { ...this.users[userId], ...updates };
            this.saveUsers();
            return { ...this.users[userId], password: undefined };
        }
        return null;
    },
    
    userExists(username, email) {
        return Object.values(this.users).some(u => 
            u.username === username || u.email === email
        );
    },
    
    getAllUsers() {
        return Object.values(this.users).map(u => ({ 
            id: u.id, 
            username: u.username, 
            email: u.email,
            createdAt: u.createdAt,
            profile: u.profile
        }));
    }
};

// Todo Database Service (Multi-User)
const TodoDatabase = {
    getUserTodos(userId) {
        const userTodos = localStorage.getItem(`juris_todos_${userId}`);
        return userTodos ? JSON.parse(userTodos) : [];
    },
    
    saveUserTodos(userId, todos) {
        localStorage.setItem(`juris_todos_${userId}`, JSON.stringify(todos));
    },
    
    deleteUserData(userId) {
        localStorage.removeItem(`juris_todos_${userId}`);
    }
};

// =================================================================
// HEADLESS COMPONENTS (Background Services)
// =================================================================

// Enhanced Auth Service with Multi-User Support
const AuthService = (props, context) => ({
    onRegistered: async (props, context) => {
        console.log('🔐 Multi-User Auth Service registered');
        
        // Initialize demo users if needed
        UserDatabase.initializeDemoUsers();
        
        // Check for existing session and restore immediately
        const savedSession = localStorage.getItem('juris_current_session');
        if (savedSession) {
            try {
                const sessionData = JSON.parse(savedSession);
                const user = UserDatabase.getUserById(sessionData.userId);
                
                if (user && sessionData.expires > Date.now()) {
                    // Restore session immediately
                    context.setState('auth.user', user);
                    context.setState('auth.isAuthenticated', true);
                    context.setState('auth.sessionId', sessionData.sessionId);
                    console.log('✅ Session restored immediately:', user.username);
                    
                    // Force a re-render of the current route to update UI
                    const currentRoute = window.location.hash.substring(1) || '/';
                    context.setState('router.currentRoute', currentRoute);
                } else {
                    // Session expired or user not found
                    localStorage.removeItem('juris_current_session');
                    console.log('🔄 Session expired or invalid');
                    
                    // If on a protected route, redirect to login
                    const currentRoute = window.location.hash.substring(1) || '/';
                    const protectedRoutes = ['/todos', '/profile'];
                    if (protectedRoutes.includes(currentRoute)) {
                        context.navigate('/login');
                    }
                }
            } catch (error) {
                console.error('Failed to restore session:', error);
                localStorage.removeItem('juris_current_session');
                
                // If on a protected route, redirect to login
                const currentRoute = window.location.hash.substring(1) || '/';
                const protectedRoutes = ['/todos', '/profile'];
                if (protectedRoutes.includes(currentRoute)) {
                    context.navigate('/login');
                }
            }
        } else {
            // No session found, check if on protected route
            const currentRoute = window.location.hash.substring(1) || '/';
            const protectedRoutes = ['/todos', '/profile'];
            if (protectedRoutes.includes(currentRoute)) {
                console.log('🔐 No session found, redirecting to login');
                context.navigate('/login');
            }
        }

        // Subscribe to auth changes and persist sessions
        const unsubscribe = context.subscribe('auth.user', (user) => {
            if (user) {
                const sessionData = {
                    userId: user.id,
                    sessionId: `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    expires: Date.now() + (7 * 24 * 60 * 60 * 1000) // 7 days
                };
                localStorage.setItem('juris_current_session', JSON.stringify(sessionData));
                context.setState('auth.sessionId', sessionData.sessionId);
            } else {
                localStorage.removeItem('juris_current_session');
                context.setState('auth.sessionId', null);
            }
        });

        return () => {
            unsubscribe();
            console.log('🧹 Auth Service cleanup');
        };
    }
});

// Enhanced Todo Storage Service with Multi-User Support
const TodoStorageService = (props, context) => ({
    onRegistered: async (props, context) => {
        console.log('📦 Multi-User Todo Storage Service registered');
        
        // Load user's todos when they authenticate
        const authUnsubscribe = context.subscribe('auth.user', (user) => {
            if (user) {
                const userTodos = TodoDatabase.getUserTodos(user.id);
                context.setState('todos.items', userTodos);
                console.log(`📥 Loaded ${userTodos.length} todos for user: ${user.username}`);
            } else {
                // Clear todos when user logs out
                context.setState('todos.items', []);
                context.setState('todos.filter', 'all');
                context.setState('todos.search', '');
                context.setState('todos.selectedCategory', 'all');
            }
        });

        // Subscribe to todo changes and auto-save to user's storage
        const todosUnsubscribe = context.subscribe('todos.items', (todos) => {
            const user = context.getState('auth.user');
            if (user && todos && Array.isArray(todos)) {
                context.setState('sync.status', 'syncing');
                
                setTimeout(() => {
                    try {
                        TodoDatabase.saveUserTodos(user.id, todos);
                        context.setState('sync.status', 'synced');
                        context.setState('sync.lastSync', new Date().toISOString());
                        console.log(`💾 Saved ${todos.length} todos for user: ${user.username}`);
                    } catch (error) {
                        context.setState('sync.status', 'error');
                        context.setState('sync.error', error.message);
                        console.error('Failed to save todos:', error);
                    }
                }, 500);
            }
        });

        return () => {
            authUnsubscribe();
            todosUnsubscribe();
            console.log('🧹 Todo Storage Service cleanup');
        };
    }
});

// Enhanced Todo Manager Service
const TodoManagerService = (props, { getState, setState }) => ({
    onRegistered: async (props, { getState, setState }) => {
        console.log('📋 Multi-User Todo Manager Service registered');
        
        // Return cleanup function if needed
        return () => {
            console.log('📋 Todo Manager Service cleanup');
        };
    },

    // Direct API methods available for destructuring
    addTodo: (text, priority = 'medium', category = 'general') => {
        const user = getState('auth.user');
        if (!user) return null;
        
        const todos = getState('todos.items', []);
        const newTodo = {
            id: `todo_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            userId: user.id,
            text: text.trim(),
            completed: false,
            priority,
            category,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            createdBy: user.username
        };
        
        setState('todos.items', [...todos, newTodo]);
        setState('todos.lastAction', { type: 'add', todo: newTodo });
        return newTodo;
    },

    toggleTodo: (id) => {
        const user = getState('auth.user');
        if (!user) return;
        
        const todos = getState('todos.items', []);
        const updatedTodos = todos.map(todo => 
            todo.id === id && todo.userId === user.id
                ? { ...todo, completed: !todo.completed, updatedAt: new Date().toISOString() }
                : todo
        );
        setState('todos.items', updatedTodos);
        
        const toggledTodo = updatedTodos.find(t => t.id === id);
        if (toggledTodo) {
            setState('todos.lastAction', { 
                type: 'toggle', 
                todo: toggledTodo,
                completed: toggledTodo.completed 
            });
        }
    },

    deleteTodo: (id) => {
        const user = getState('auth.user');
        if (!user) return;
        
        const todos = getState('todos.items', []);
        const todoToDelete = todos.find(t => t.id === id && t.userId === user.id);
        if (!todoToDelete) return;
        
        const updatedTodos = todos.filter(todo => todo.id !== id);
        setState('todos.items', updatedTodos);
        setState('todos.lastAction', { type: 'delete', todo: todoToDelete });
    },

    updateTodo: (id, updates) => {
        const user = getState('auth.user');
        if (!user) return;
        
        const todos = getState('todos.items', []);
        const updatedTodos = todos.map(todo => 
            todo.id === id && todo.userId === user.id
                ? { ...todo, ...updates, updatedAt: new Date().toISOString() }
                : todo
        );
        setState('todos.items', updatedTodos);
        
        const updatedTodo = updatedTodos.find(t => t.id === id);
        if (updatedTodo) {
            setState('todos.lastAction', { type: 'update', todo: updatedTodo });
        }
    },

    clearCompleted: () => {
        const user = getState('auth.user');
        if (!user) return;
        
        const todos = getState('todos.items', []);
        const userTodos = todos.filter(t => t.userId === user.id);
        const completed = userTodos.filter(t => t.completed);
        const remaining = todos.filter(t => t.userId !== user.id || !t.completed);
        
        setState('todos.items', remaining);
        setState('todos.lastAction', { 
            type: 'clearCompleted', 
            count: completed.length 
        });
    },

    getFilteredTodos: (filter, search, category) => {
        const user = getState('auth.user');
        if (!user) return [];
        
        const todos = getState('todos.items', []);
        const userTodos = todos.filter(todo => todo.userId === user.id);
        
        return userTodos.filter(todo => {
            if (filter === 'active' && todo.completed) return false;
            if (filter === 'completed' && !todo.completed) return false;
            
            if (search && !todo.text.toLowerCase().includes(search.toLowerCase())) {
                return false;
            }
            
            if (category && category !== 'all' && todo.category !== category) {
                return false;
            }
            
            return true;
        });
    },

    getStats: () => {
        const user = getState('auth.user');
        if (!user) return { total: 0, completed: 0, active: 0, high: 0, medium: 0, low: 0 };
        
        const todos = getState('todos.items', []);
        const userTodos = todos.filter(t => t.userId === user.id);
        
        return {
            total: userTodos.length,
            completed: userTodos.filter(t => t.completed).length,
            active: userTodos.filter(t => !t.completed).length,
            high: userTodos.filter(t => t.priority === 'high').length,
            medium: userTodos.filter(t => t.priority === 'medium').length,
            low: userTodos.filter(t => t.priority === 'low').length
        };
    },

    getUserCategories: () => {
        const user = getState('auth.user');
        if (!user) return [];
        
        const todos = getState('todos.items', []);
        const userTodos = todos.filter(t => t.userId === user.id);
        return [...new Set(userTodos.map(t => t.category))];
    },

    exportUserData: () => {
        const user = getState('auth.user');
        if (!user) return null;
        
        const todos = getState('todos.items', []);
        const userTodos = todos.filter(t => t.userId === user.id);
        
        return {
            user: { ...user },
            todos: userTodos,
            exportedAt: new Date().toISOString(),
            version: '1.0'
        };
    },

    deleteAllUserData: () => {
        const user = getState('auth.user');
        if (!user) return;
        
        TodoDatabase.deleteUserData(user.id);
        setState('todos.items', []);
        setState('todos.lastAction', { type: 'deleteAllData' });
    }
});

// User Management Service
const UserManagementService = (props, { getState, setState }) => ({
    onRegistered: async (props, { getState, setState }) => {
        console.log('👥 User Management Service registered');
        MobileDebugger.log('UserManagementService onRegistered called');
        
        // Return cleanup function if needed
        return () => {
            console.log('👥 User Management Service cleanup');
        };
    },

    // Direct API methods available for destructuring
    register: async (userData) => {
        MobileDebugger.log('userService.register called', userData);
        
        if (!userData.username || !userData.email || !userData.password) {
            throw new Error('All fields are required');
        }
        
        if (userData.username.length < 3) {
            throw new Error('Username must be at least 3 characters');
        }
        
        if (userData.password.length < 6) {
            throw new Error('Password must be at least 6 characters');
        }
        
        if (UserDatabase.userExists(userData.username, userData.email)) {
            throw new Error('Username or email already exists');
        }
        
        const user = UserDatabase.createUser(userData);
        console.log('✅ User created:', user.username);
        MobileDebugger.log('User created successfully', user);
        return user;
    },
    
    login: async (username, password) => {
        MobileDebugger.log('userService.login called', { username, passwordProvided: !!password });
        
        if (!username || !password) {
            throw new Error('Username and password are required');
        }
        
        const user = UserDatabase.authenticateUser(username, password);
        if (!user) {
            throw new Error('Invalid username or password');
        }
        
        console.log('✅ User authenticated:', user.username);
        MobileDebugger.log('User authenticated successfully', user);
        return user;
    },
    
    updateProfile: async (updates) => {
        const currentUser = getState('auth.user');
        if (!currentUser) {
            throw new Error('User not authenticated');
        }
        
        const updatedUser = UserDatabase.updateUser(currentUser.id, {
            profile: { ...currentUser.profile, ...updates }
        });
        
        if (updatedUser) {
            setState('auth.user', updatedUser);
            console.log('✅ Profile updated:', updatedUser.username);
            return updatedUser;
        }
        
        throw new Error('Failed to update profile');
    },
    
    getAllUsers: () => {
        return UserDatabase.getAllUsers();
    },
    
    getCurrentUser: () => {
        return getState('auth.user');
    }
});

// =================================================================
// UI COMPONENTS
// =================================================================

// Enhanced Navigation Component
const Navigation = (props, context) => ({
    render: () => ({
        nav: {
            className: 'header',
            children: [
                {
                    div: {
                        className: 'container',
                        children: [
                            {
                                div: {
                                    className: 'nav',
                                    children: [
                                        {
                                            a: {
                                                href: '#/',
                                                className: 'logo',
                                                onClick: (e) => {
                                                    e.preventDefault();
                                                    context.navigate('/');
                                                },
                                                children: [
                                                    { span: { text: '✅' } },
                                                    { span: { text: 'TodoMaster' } },
                                                    { span: { text: ' Multi-User', style: { fontSize: '0.7em', opacity: '0.8' } } }
                                                ]
                                            }
                                        },
                                        {
                                            ul: {
                                                className: 'nav-links',
                                                children: () => {
                                                    const isAuthenticated = context.getState('auth.isAuthenticated', false);
                                                    const user = context.getState('auth.user', null);
                                                    const currentRoute = context.getState('router.currentRoute', '/');

                                                    if (isAuthenticated) {
                                                        return [
                                                            {
                                                                li: {
                                                                    children: [
                                                                        {
                                                                            a: {
                                                                                href: '#/todos',
                                                                                className: currentRoute === '/todos' ? 'active' : '',
                                                                                text: '📋 My Todos',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/todos');
                                                                                }
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            {
                                                                li: {
                                                                    children: [
                                                                        {
                                                                            a: {
                                                                                href: '#/profile',
                                                                                className: currentRoute === '/profile' ? 'active' : '',
                                                                                text: '👤 Profile',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/profile');
                                                                                }
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            {
                                                                li: {
                                                                    children: [
                                                                        {
                                                                            span: {
                                                                                text: `👋 ${user?.profile?.displayName || user?.username || 'User'}`,
                                                                                style: { color: '#c4b5fd', fontSize: '0.9rem' }
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            {
                                                                li: {
                                                                    children: [
                                                                        {
                                                                            button: {
                                                                                className: 'btn btn-secondary',
                                                                                text: '🚪 Logout',
                                                                                onClick: () => {
                                                                                    if (confirm('Are you sure you want to logout?')) {
                                                                                        context.setState('auth.user', null);
                                                                                        context.setState('auth.isAuthenticated', false);
                                                                                        context.navigate('/');
                                                                                    }
                                                                                }
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ];
                                                    } else {
                                                        return [
                                                            {
                                                                li: {
                                                                    children: [
                                                                        {
                                                                            a: {
                                                                                href: '#/users',
                                                                                className: currentRoute === '/users' ? 'active' : '',
                                                                                text: '👥 Users',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/users');
                                                                                }
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            {
                                                                li: {
                                                                    children: [
                                                                        {
                                                                            a: {
                                                                                href: '#/login',
                                                                                className: currentRoute === '/login' ? 'active' : '',
                                                                                text: '🔑 Login',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/login');
                                                                                }
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            },
                                                            {
                                                                li: {
                                                                    children: [
                                                                        {
                                                                            a: {
                                                                                href: '#/register',
                                                                                className: currentRoute === '/register' ? 'active' : '',
                                                                                text: '📝 Register',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/register');
                                                                                }
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ];
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    })
});

// Privacy Disclaimer Component
const PrivacyDisclaimer = (props, context) => ({
    render: () => ({
        div: {
            className: 'privacy-disclaimer',
            style: {
                display: () => context.getState('disclaimer.isVisible', true) ? 'block' : 'none',
                position: 'fixed',
                bottom: '20px',
                left: '20px',
                right: '20px',
                background: 'rgba(15, 23, 42, 0.95)',
                backdropFilter: 'blur(10px)',
                border: '1px solid rgba(124, 58, 237, 0.3)',
                borderRadius: '12px',
                padding: '1rem',
                color: '#e2e8f0',
                fontSize: '0.85rem',
                zIndex: '9999',
                maxWidth: '600px',
                margin: '0 auto',
                boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)',
                transition: 'all 0.3s ease',
                animation: 'slideInUp 0.5s ease-out'
            },
            children: [
                {
                    div: {
                        style: { 
                            display: 'flex', 
                            alignItems: 'flex-start', 
                            gap: '0.75rem',
                            marginBottom: '0.75rem'
                        },
                        children: [
                            {
                                div: {
                                    style: { 
                                        fontSize: '1.2rem',
                                        flexShrink: '0',
                                        marginTop: '0.1rem'
                                    },
                                    text: '🔒'
                                }
                            },
                            {
                                div: {
                                    style: { flex: '1' },
                                    children: [
                                        {
                                            strong: {
                                                text: 'Privacy Notice: ',
                                                style: { color: '#c4b5fd' }
                                            }
                                        },
                                        {
                                            span: {
                                                text: 'This is a demo application. All data (users, todos, sessions) is stored locally in your browser\'s localStorage. '
                                            }
                                        },
                                        {
                                            strong: {
                                                text: 'Nothing is sent to any server.',
                                                style: { color: '#22c55e' }
                                            }
                                        },
                                        {
                                            span: {
                                                text: ' Your data remains completely private and will be cleared if you clear your browser data.'
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                button: {
                                    style: {
                                        background: 'none',
                                        border: 'none',
                                        color: '#94a3b8',
                                        fontSize: '1.2rem',
                                        cursor: 'pointer',
                                        padding: '0.25rem',
                                        borderRadius: '4px',
                                        transition: 'all 0.2s ease',
                                        flexShrink: '0'
                                    },
                                    text: '✕',
                                    title: 'Dismiss privacy notice',
                                    onClick: () => {
                                        console.log('🔒 Privacy disclaimer dismissed');
                                        context.setState('disclaimer.isVisible', false);
                                        localStorage.setItem('juris_disclaimer_dismissed', 'true');
                                    },
                                    onMouseOver: (e) => {
                                        e.target.style.background = 'rgba(255, 255, 255, 0.1)';
                                        e.target.style.color = '#ffffff';
                                    },
                                    onMouseOut: (e) => {
                                        e.target.style.background = 'none';
                                        e.target.style.color = '#94a3b8';
                                    }
                                }
                            }
                        ]
                    }
                },
                {
                    div: {
                        style: { 
                            display: 'flex', 
                            gap: '0.5rem',
                            alignItems: 'center',
                            justifyContent: 'space-between',
                            flexWrap: 'wrap'
                        },
                        children: [
                            {
                                div: {
                                    style: { 
                                        display: 'flex',
                                        gap: '1rem',
                                        fontSize: '0.75rem',
                                        opacity: '0.8',
                                        flexWrap: 'wrap'
                                    },
                                    children: [
                                        {
                                            span: {
                                                children: [
                                                    { span: { text: '💾 Storage: localStorage' } }
                                                ]
                                            }
                                        },
                                        {
                                            span: {
                                                children: [
                                                    { span: { text: '🌐 Network: None' } }
                                                ]
                                            }
                                        },
                                        {
                                            span: {
                                                children: [
                                                    { span: { text: '🔐 Privacy: 100% Local' } }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },
                            {
                                div: {
                                    style: { display: 'flex', gap: '0.5rem' },
                                    children: [
                                        {
                                            button: {
                                                className: 'btn btn-small',
                                                style: { 
                                                    fontSize: '0.75rem',
                                                    padding: '0.4rem 0.8rem'
                                                },
                                                text: '📊 View Storage',
                                                onClick: () => {
                                                    const users = localStorage.getItem('juris_users_db');
                                                    const currentSession = localStorage.getItem('juris_current_session');
                                                    const storageKeys = Object.keys(localStorage).filter(key => 
                                                        key.startsWith('juris_')
                                                    );
                                                    
                                                    const storageInfo = {
                                                        users: users ? JSON.parse(users) : {},
                                                        session: currentSession ? JSON.parse(currentSession) : null,
                                                        todoStorageKeys: storageKeys.filter(key => key.startsWith('juris_todos_')),
                                                        totalKeys: storageKeys.length
                                                    };
                                                    
                                                    console.log('🔍 Local Storage Contents:', storageInfo);
                                                    alert(`📊 Local Storage Contents:\n\n` +
                                                        `• Users: ${Object.keys(storageInfo.users).length}\n` +
                                                        `• Todo Storage: ${storageInfo.todoStorageKeys.length} users\n` +
                                                        `• Session: ${storageInfo.session ? 'Active' : 'None'}\n` +
                                                        `• Total Keys: ${storageInfo.totalKeys}\n\n` +
                                                        `Check browser console for detailed view.`);
                                                }
                                            }
                                        },
                                        {
                                            button: {
                                                className: 'btn btn-secondary btn-small',
                                                style: { 
                                                    fontSize: '0.75rem',
                                                    padding: '0.4rem 0.8rem'
                                                },
                                                text: 'Dismiss',
                                                onClick: () => {
                                                    console.log('🔒 Privacy disclaimer dismissed via button');
                                                    context.setState('disclaimer.isVisible', false);
                                                    localStorage.setItem('juris_disclaimer_dismissed', 'true');
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    }),
    
    onRegistered: (props, context) => {
        console.log('🔒 Privacy Disclaimer component registered');
        
        // Check if disclaimer was previously dismissed
        const wasDismissed = localStorage.getItem('juris_disclaimer_dismissed');
        if (wasDismissed === 'true') {
            console.log('🔒 Disclaimer was previously dismissed, hiding...');
            context.setState('disclaimer.isVisible', false);
        } else {
            console.log('🔒 Showing privacy disclaimer...');
            context.setState('disclaimer.isVisible', true);
        }
        
        // Auto-hide disclaimer after 30 seconds if not dismissed
        setTimeout(() => {
            const isStillVisible = context.getState('disclaimer.isVisible', false);
            if (isStillVisible) {
                console.log('🔒 Auto-hiding disclaimer after 30 seconds');
                context.setState('disclaimer.isVisible', false);
            }
        }, 30000);
        
        return () => {
            console.log('🔒 Privacy Disclaimer component cleanup');
        };
    }
});

// Enhanced Sync Status Component (now shows disclaimer status)
const SyncStatus = (props, context) => ({
    render: () => {
        const status = context.getState('sync.status', 'idle');
        const lastSync = context.getState('sync.lastSync', null);
        const user = context.getState('auth.user', null);
        const disclaimerVisible = context.getState('disclaimer.isVisible', true);

        // Adjust position if disclaimer is visible
        const bottomPosition = disclaimerVisible ? '180px' : '20px';

        if (status === 'idle' || !user) return { div: {} };

        const statusMap = {
            syncing: { icon: '⏳', text: 'Syncing...', class: 'syncing' },
            synced: { icon: '✅', text: `Synced (${user.username})`, class: 'synced' },
            error: { icon: '❌', text: 'Sync Error', class: 'error' }
        };

        const statusInfo = statusMap[status] || statusMap.idle;

        return {
            div: {
                className: `sync-status ${statusInfo.class}`,
                style: { bottom: bottomPosition },
                children: [
                    { span: { text: statusInfo.icon } },
                    { span: { text: statusInfo.text } },
                    lastSync && status === 'synced' ? {
                        small: { 
                            text: ` (${new Date(lastSync).toLocaleTimeString()})`,
                            style: { opacity: '0.7', marginLeft: '0.5rem' }
                        }
                    } : null
                ].filter(Boolean)
            }
        };
    }
});

// Enhanced Login Page
// Enhanced Login Page - FIXED destructuring
const LoginPage = (props, { getState, setState, navigate, UserManagementService }) => ({
    render: () => ({
        div: {
            className: 'main-content',
            children: [
                {
                    div: {
                        className: 'container',
                        children: [
                            {
                                div: {
                                    className: 'page-content',
                                    children: [
                                        {
                                            div: {
                                                className: 'auth-container',
                                                children: () => {
                                                    const isLoading = getState('auth.isLoading', false);
                                                    const error = getState('auth.error', null);

                                                    return [
                                                        {
                                                            h1: {
                                                                className: 'page-title',
                                                                text: '🔑 Login to TodoMaster',
                                                                style: { textAlign: 'center', fontSize: '2rem' }
                                                            }
                                                        },
                                                        {
                                                            p: {
                                                                className: 'page-subtitle',
                                                                text: 'Sign in to access your personal todo workspace.',
                                                                style: { textAlign: 'center' }
                                                            }
                                                        },
                                                        {
                                                            div: {
                                                                className: 'success-message',
                                                                style: { textAlign: 'center', marginBottom: '1rem' },
                                                                children: [
                                                                    { strong: { text: '🎭 Demo Accounts Available:' } },
                                                                    { br: {} },
                                                                    { span: { text: 'Username: alice, Password: demo123' } },
                                                                    { br: {} },
                                                                    { span: { text: 'Username: bob, Password: demo123' } },
                                                                    { br: {} },
                                                                    { span: { text: 'Username: charlie, Password: demo123' } }
                                                                ]
                                                            }
                                                        },
                                                        error ? {
                                                            div: {
                                                                className: 'error-message',
                                                                text: error
                                                            }
                                                        } : null,
                                                        {
                                                            form: {
                                                                onSubmit: async (e) => {
                                                                    e.preventDefault();
                                                                    
                                                                    MobileDebugger.log('Login form submitted');
                                                                    
                                                                    const formData = new FormData(e.target);
                                                                    const username = formData.get('username');
                                                                    const password = formData.get('password');

                                                                    setState('auth.isLoading', true);
                                                                    setState('auth.error', null);

                                                                    try {
                                                                        MobileDebugger.log('Calling UserManagementService.login', { username });
                                                                        
                                                                        // Simulate API delay
                                                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                                                        
                                                                        // FIXED: Now UserManagementService is properly destructured
                                                                        const user = await UserManagementService.login(username, password);
                                                                        setState('auth.user', user);
                                                                        setState('auth.isAuthenticated', true);
                                                                        setState('auth.isLoading', false);
                                                                        navigate('/todos');
                                                                    } catch (error) {
                                                                        MobileDebugger.log('Login error', error);
                                                                        setState('auth.error', error.message);
                                                                        setState('auth.isLoading', false);
                                                                    }
                                                                },
                                                                children: [
                                                                    {
                                                                        div: {
                                                                            className: 'form-group',
                                                                            children: [
                                                                                {
                                                                                    label: {
                                                                                        text: 'Username:',
                                                                                        htmlFor: 'username'
                                                                                    }
                                                                                },
                                                                                {
                                                                                    input: {
                                                                                        type: 'text',
                                                                                        name: 'username',
                                                                                        id: 'username',
                                                                                        className: 'form-control',
                                                                                        placeholder: 'Enter your username',
                                                                                        required: true,
                                                                                        disabled: isLoading
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            className: 'form-group',
                                                                            children: [
                                                                                {
                                                                                    label: {
                                                                                        text: 'Password:',
                                                                                        htmlFor: 'password'
                                                                                    }
                                                                                },
                                                                                {
                                                                                    input: {
                                                                                        type: 'password',
                                                                                        name: 'password',
                                                                                        id: 'password',
                                                                                        className: 'form-control',
                                                                                        placeholder: 'Enter your password',
                                                                                        required: true,
                                                                                        disabled: isLoading
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            style: { display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap' },
                                                                            children: [
                                                                                {
                                                                                    button: {
                                                                                        type: 'submit',
                                                                                        className: 'btn',
                                                                                        disabled: isLoading,
                                                                                        children: isLoading ? [
                                                                                            { span: { className: 'spinner' } },
                                                                                            { span: { text: 'Signing in...' } }
                                                                                        ] : [
                                                                                            { span: { text: '🔑 Sign In' } }
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                {
                                                                                    a: {
                                                                                        href: '#/register',
                                                                                        className: 'btn btn-secondary',
                                                                                        text: '📝 Create Account',
                                                                                        onClick: (e) => {
                                                                                            e.preventDefault();
                                                                                            navigate('/register');
                                                                                        }
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    ].filter(Boolean);
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    })
});

// Enhanced Register Page with service injection
const RegisterPage = (props, { getState, setState, navigate, services }) => ({
    render: () => ({
        div: {
            className: 'main-content',
            children: [
                {
                    div: {
                        className: 'container',
                        children: [
                            {
                                div: {
                                    className: 'page-content',
                                    children: [
                                        {
                                            div: {
                                                className: 'auth-container',
                                                children: () => {
                                                    const isLoading = getState('auth.isLoading', false);
                                                    const error = getState('auth.error', null);

                                                    return [
                                                        {
                                                            h1: {
                                                                className: 'page-title',
                                                                text: '📝 Join TodoMaster',
                                                                style: { textAlign: 'center', fontSize: '2rem' }
                                                            }
                                                        },
                                                        {
                                                            p: {
                                                                className: 'page-subtitle',
                                                                text: 'Create your account to start managing todos in your personal workspace.',
                                                                style: { textAlign: 'center' }
                                                            }
                                                        },
                                                        error ? {
                                                            div: {
                                                                className: 'error-message',
                                                                text: error
                                                            }
                                                        } : null,
                                                        {
                                                            form: {
                                                                onSubmit: async (e) => {
                                                                    e.preventDefault();
                                                                    const formData = new FormData(e.target);
                                                                    const username = formData.get('username');
                                                                    const email = formData.get('email');
                                                                    const password = formData.get('password');
                                                                    const confirmPassword = formData.get('confirmPassword');

                                                                    setState('auth.isLoading', true);
                                                                    setState('auth.error', null);

                                                                    try {
                                                                        if (password !== confirmPassword) {
                                                                            throw new Error('Passwords do not match');
                                                                        }

                                                                        // Simulate API delay
                                                                        await new Promise(resolve => setTimeout(resolve, 1000));
                                                                        
                                                                        const user = await UserManagementService.register({
                                                                            username, email, password
                                                                        });
                                                                        
                                                                        setState('auth.user', user);
                                                                        setState('auth.isAuthenticated', true);
                                                                        setState('auth.isLoading', false);
                                                                        navigate('/todos');
                                                                    } catch (error) {
                                                                        setState('auth.error', error.message);
                                                                        setState('auth.isLoading', false);
                                                                    }
                                                                },
                                                                children: [
                                                                    {
                                                                        div: {
                                                                            className: 'form-group',
                                                                            children: [
                                                                                {
                                                                                    label: {
                                                                                        text: 'Username:',
                                                                                        htmlFor: 'username'
                                                                                    }
                                                                                },
                                                                                {
                                                                                    input: {
                                                                                        type: 'text',
                                                                                        name: 'username',
                                                                                        id: 'username',
                                                                                        className: 'form-control',
                                                                                        placeholder: 'Choose a username (min 3 chars)',
                                                                                        required: true,
                                                                                        minLength: 3,
                                                                                        disabled: isLoading
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            className: 'form-group',
                                                                            children: [
                                                                                {
                                                                                    label: {
                                                                                        text: 'Email:',
                                                                                        htmlFor: 'email'
                                                                                    }
                                                                                },
                                                                                {
                                                                                    input: {
                                                                                        type: 'email',
                                                                                        name: 'email',
                                                                                        id: 'email',
                                                                                        className: 'form-control',
                                                                                        placeholder: 'Enter your email',
                                                                                        required: true,
                                                                                        disabled: isLoading
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            className: 'form-group',
                                                                            children: [
                                                                                {
                                                                                    label: {
                                                                                        text: 'Password:',
                                                                                        htmlFor: 'password'
                                                                                    }
                                                                                },
                                                                                {
                                                                                    input: {
                                                                                        type: 'password',
                                                                                        name: 'password',
                                                                                        id: 'password',
                                                                                        className: 'form-control',
                                                                                        placeholder: 'Create a password (min 6 chars)',
                                                                                        required: true,
                                                                                        minLength: 6,
                                                                                        disabled: isLoading
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            className: 'form-group',
                                                                            children: [
                                                                                {
                                                                                    label: {
                                                                                        text: 'Confirm Password:',
                                                                                        htmlFor: 'confirmPassword'
                                                                                    }
                                                                                },
                                                                                {
                                                                                    input: {
                                                                                        type: 'password',
                                                                                        name: 'confirmPassword',
                                                                                        id: 'confirmPassword',
                                                                                        className: 'form-control',
                                                                                        placeholder: 'Confirm your password',
                                                                                        required: true,
                                                                                        minLength: 6,
                                                                                        disabled: isLoading
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            style: { display: 'flex', gap: '1rem', justifyContent: 'center', flexWrap: 'wrap' },
                                                                            children: [
                                                                                {
                                                                                    button: {
                                                                                        type: 'submit',
                                                                                        className: 'btn',
                                                                                        disabled: isLoading,
                                                                                        children: isLoading ? [
                                                                                            { span: { className: 'spinner' } },
                                                                                            { span: { text: 'Creating Account...' } }
                                                                                        ] : [
                                                                                            { span: { text: '📝 Create Account' } }
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                {
                                                                                    a: {
                                                                                        href: '#/login',
                                                                                        className: 'btn btn-secondary',
                                                                                        text: '🔑 Sign In Instead',
                                                                                        onClick: (e) => {
                                                                                            e.preventDefault();
                                                                                            navigate('/login');
                                                                                        }
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    ].filter(Boolean);
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    })
});

// User Profile Page
const ProfilePage = (props, { getState, setState, navigate, services, UserManagementService, TodoManagerService }) => ({
    
        
    render: () => ({
        div: {
            className: 'main-content',
            children: [
                {
                    div: {
                        className: 'container',
                        children: [
                            {
                                div: {
                                    className: 'page-content',
                                    children: () => {
                                        const user = getState('auth.user');
                                        
                                        // Get services from service injection
                                        const stats = TodoManagerService?.getStats() || {};
                                        const isUpdating = getState('profile.isUpdating', false);
                                        const updateMessage = getState('profile.updateMessage', null);

                                        return [
                                            {
                                                h1: {
                                                    className: 'page-title',
                                                    text: '👤 User Profile'
                                                }
                                            },
                                            {
                                                div: {
                                                    style: { 
                                                        display: 'grid', 
                                                        gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', 
                                                        gap: '2rem' 
                                                    },
                                                    children: [
                                                        // Profile Info with service injection
                                                        {
                                                            div: {
                                                                className: 'todo-form',
                                                                children: [
                                                                    {
                                                                        h3: {
                                                                            text: '📋 Profile Information',
                                                                            style: { marginBottom: '1.5rem' }
                                                                        }
                                                                    },
                                                                    updateMessage ? {
                                                                        div: {
                                                                            className: updateMessage.type === 'success' ? 'success-message' : 'error-message',
                                                                            text: updateMessage.text
                                                                        }
                                                                    } : null,
                                                                    {
                                                                        form: {
                                                                            onSubmit: async (e) => {
                                                                                e.preventDefault();
                                                                                const formData = new FormData(e.target);
                                                                                const displayName = formData.get('displayName');
                                                                                
                                                                                setState('profile.isUpdating', true);
                                                                                setState('profile.updateMessage', null);
                                                                                
                                                                                try {
                                                                                    await new Promise(resolve => setTimeout(resolve, 500));
                                                                                    await UserManagementService?.updateProfile({ displayName });
                                                                                    setState('profile.updateMessage', {
                                                                                        type: 'success',
                                                                                        text: 'Profile updated successfully!'
                                                                                    });
                                                                                } catch (error) {
                                                                                    setState('profile.updateMessage', {
                                                                                        type: 'error',
                                                                                        text: error.message
                                                                                    });
                                                                                } finally {
                                                                                    setState('profile.isUpdating', false);
                                                                                }
                                                                            },
                                                                            children: [
                                                                                {
                                                                                    div: {
                                                                                        className: 'form-group',
                                                                                        children: [
                                                                                            {
                                                                                                label: {
                                                                                                    text: 'Username:',
                                                                                                    htmlFor: 'username'
                                                                                                }
                                                                                            },
                                                                                            {
                                                                                                input: {
                                                                                                    type: 'text',
                                                                                                    id: 'username',
                                                                                                    className: 'form-control',
                                                                                                    value: user?.username || '',
                                                                                                    disabled: true,
                                                                                                    style: { opacity: '0.7' }
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                {
                                                                                    div: {
                                                                                        className: 'form-group',
                                                                                        children: [
                                                                                            {
                                                                                                label: {
                                                                                                    text: 'Display Name:',
                                                                                                    htmlFor: 'displayName'
                                                                                                }
                                                                                            },
                                                                                            {
                                                                                                input: {
                                                                                                    type: 'text',
                                                                                                    name: 'displayName',
                                                                                                    id: 'displayName',
                                                                                                    className: 'form-control',
                                                                                                    placeholder: 'Enter display name',
                                                                                                    value: user?.profile?.displayName || '',
                                                                                                    disabled: isUpdating
                                                                                                }
                                                                                            }
                                                                                        ]
                                                                                    }
                                                                                },
                                                                                {
                                                                                    button: {
                                                                                        type: 'submit',
                                                                                        className: 'btn',
                                                                                        disabled: isUpdating,
                                                                                        children: isUpdating ? [
                                                                                            { span: { className: 'spinner' } },
                                                                                            { span: { text: 'Updating...' } }
                                                                                        ] : [
                                                                                            { span: { text: '💾 Update Profile' } }
                                                                                        ]
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                ].filter(Boolean)
                                                            }
                                                        },
                                                        
                                                        // Data Management with service injection
                                                        {
                                                            div: {
                                                                className: 'todo-form',
                                                                children: [
                                                                    {
                                                                        h3: {
                                                                            text: '🔧 Data Management',
                                                                            style: { marginBottom: '1.5rem' }
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            style: { display: 'flex', flexDirection: 'column', gap: '1rem' },
                                                                            children: [
                                                                                {
                                                                                    button: {
                                                                                        className: 'btn btn-secondary',
                                                                                        text: '📥 Export My Data',
                                                                                        onClick: () => {
                                                                                            const data = TodoManagerService?.exportUserData();
                                                                                            if (data) {
                                                                                                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                                                                                                const url = URL.createObjectURL(blob);
                                                                                                const a = document.createElement('a');
                                                                                                a.href = url;
                                                                                                a.download = `todomaster_${user?.username}_${new Date().toISOString().split('T')[0]}.json`;
                                                                                                a.click();
                                                                                                URL.revokeObjectURL(url);
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                },
                                                                                {
                                                                                    button: {
                                                                                        className: 'btn btn-danger',
                                                                                        text: '🗑️ Delete All My Data',
                                                                                        onClick: () => {
                                                                                            if (confirm('⚠️ This will permanently delete ALL your todos. This action cannot be undone!\n\nType "DELETE" to confirm:')) {
                                                                                                const confirmation = prompt('Type "DELETE" to confirm:');
                                                                                                if (confirmation === 'DELETE') {
                                                                                                    services.TodoManagerService?.deleteAllUserData();
                                                                                                    alert('All your data has been deleted.');
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                            ]
                                                                        }
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    ]
                                                }
                                            }
                                        ];
                                    }
                                }
                            }
                        ]
                    }
                }
            ]
        }
    })
});

// Users List Page (Public)
const UsersPage = (props, { getState, setState, navigate, services,UserManagementService }) => ({
    render: () => ({
        div: {
            className: 'main-content',
            children: [
                {
                    div: {
                        className: 'container',
                        children: [
                            {
                                div: {
                                    className: 'page-content',
                                    children: [
                                        {
                                            h1: {
                                                className: 'page-title',
                                                text: '👥 TodoMaster Users'
                                            }
                                        },
                                        {
                                            p: {
                                                className: 'page-subtitle',
                                                text: 'See who else is using TodoMaster! Each user has their own private workspace.'
                                            }
                                        },
                                        {
                                            div: {
                                                className: 'todo-list',
                                                children: () => {
                                                    // Get user service from service injection
                                                    const users = UserManagementService.getAllUsers() || [];
                                                    
                                                    if (users.length === 0) {
                                                        return [
                                                            {
                                                                div: {
                                                                    className: 'empty-state',
                                                                    children: [
                                                                        {
                                                                            div: {
                                                                                className: 'empty-state-icon',
                                                                                text: '👥'
                                                                            }
                                                                        },
                                                                        {
                                                                            h3: {
                                                                                text: 'No Users Yet'
                                                                            }
                                                                        },
                                                                        {
                                                                            p: {
                                                                                text: 'Be the first to create an account!'
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ];
                                                    }
                                                    
                                                    return users.map(user => ({
                                                        div: {
                                                            className: 'todo-item',
                                                            children: [
                                                                {
                                                                    div: {
                                                                        className: 'todo-content',
                                                                        style: { gridTemplateColumns: 'auto 1fr' },
                                                                        children: [
                                                                            {
                                                                                div: {
                                                                                    style: { fontSize: '2rem' },
                                                                                    text: '👤'
                                                                                }
                                                                            },
                                                                            {
                                                                                div: {
                                                                                    className: 'todo-details',
                                                                                    children: [
                                                                                        {
                                                                                            div: {
                                                                                                className: 'todo-text',
                                                                                                text: user.profile?.displayName || user.username
                                                                                            }
                                                                                        },
                                                                                        {
                                                                                            div: {
                                                                                                className: 'todo-meta',
                                                                                                children: [
                                                                                                    {
                                                                                                        span: {
                                                                                                            className: 'category',
                                                                                                            text: `@${user.username}`
                                                                                                        }
                                                                                                    },
                                                                                                    {
                                                                                                        span: {
                                                                                                            className: 'todo-date',
                                                                                                            text: `Joined ${new Date(user.createdAt).toLocaleDateString()}`
                                                                                                        }
                                                                                                    }
                                                                                                ]
                                                                                            }
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }));
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    })
});

// Keep the existing TodosPage component (same as before)
const TodosPage = (props, { getState, setState, navigate, services, TodoManagerService }) => ({
    render: () => ({
        div: {
            className: 'main-content',
            children: [
                {
                    div: {
                        className: 'container',
                        children: [
                            {
                                div: {
                                    className: 'page-content',
                                    children: [
                                        // Header with stats
                                        {
                                            div: {
                                                className: 'todo-header',
                                                children: [
                                                    {
                                                        h1: {
                                                            className: 'page-title',
                                                            children: () => {
                                                                const user = getState('auth.user');
                                                                return [
                                                                    { span: { text: '📋 ' } },
                                                                    { span: { text: `${user?.profile?.displayName || user?.username || 'User'}'s Todos` } }
                                                                ];
                                                            }
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            className: 'todo-stats',
                                                            children: () => {
                                                                // Get todo service from service injection
                                                                const stats = TodoManagerService?.getStats() || {};
                                                                
                                                                return [
                                                                    {
                                                                        div: {
                                                                            className: 'stat',
                                                                            children: [
                                                                                { span: { text: '📝 Total: ' } },
                                                                                { span: { className: 'stat-number', text: (stats.total || 0).toString() } }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            className: 'stat',
                                                                            children: [
                                                                                { span: { text: '✅ Done: ' } },
                                                                                { span: { className: 'stat-number', text: (stats.completed || 0).toString() } }
                                                                            ]
                                                                        }
                                                                    },
                                                                    {
                                                                        div: {
                                                                            className: 'stat',
                                                                            children: [
                                                                                { span: { text: '⏳ Active: ' } },
                                                                                { span: { className: 'stat-number', text: (stats.active || 0).toString() } }
                                                                            ]
                                                                        }
                                                                    }
                                                                ];
                                                            }
                                                        }
                                                    }
                                                ]
                                            }
                                        },

                                        // Add Todo Form with service injection
                                        {
                                            div: {
                                                className: 'todo-form',
                                                children: [
                                                    {
                                                        h3: {
                                                            text: '➕ Add New Todo'
                                                        }
                                                    },
                                                    {
                                                        form: {
                                                            onSubmit: (e) => {
                                                                e.preventDefault();
                                                                const formData = new FormData(e.target);
                                                                const text = formData.get('text');
                                                                const priority = formData.get('priority');
                                                                const category = formData.get('category');

                                                                // Get todo service from service injection
                                                                if (text.trim() && TodoManagerService) {
                                                                    TodoManagerService.addTodo(text, priority, category);
                                                                    e.target.reset();
                                                                    // Reset category to user's default
                                                                    const user = getState('auth.user');
                                                                    const defaultCategory = user?.profile?.preferences?.defaultCategory || 'general';
                                                                    e.target.querySelector('[name="category"]').value = defaultCategory;
                                                                }
                                                            },
                                                            children: [
                                                                {
                                                                    div: {
                                                                        className: 'todo-input-group',
                                                                        children: [
                                                                            {
                                                                                input: {
                                                                                    type: 'text',
                                                                                    name: 'text',
                                                                                    className: 'todo-input',
                                                                                    placeholder: 'What needs to be done?',
                                                                                    required: true
                                                                                }
                                                                            },
                                                                            {
                                                                                select: {
                                                                                    name: 'priority',
                                                                                    className: 'priority-select',
                                                                                    children: () => {
                                                                                        const user = getState('auth.user');
                                                                                        const defaultPriority = user?.profile?.preferences?.defaultPriority || 'medium';
                                                                                        return [
                                                                                            { option: { value: 'low', text: '🟢 Low', selected: defaultPriority === 'low' } },
                                                                                            { option: { value: 'medium', text: '🟡 Medium', selected: defaultPriority === 'medium' } },
                                                                                            { option: { value: 'high', text: '🔴 High', selected: defaultPriority === 'high' } }
                                                                                        ];
                                                                                    }
                                                                                }
                                                                            },
                                                                            {
                                                                                input: {
                                                                                    type: 'text',
                                                                                    name: 'category',
                                                                                    className: 'category-input',
                                                                                    placeholder: 'Category',
                                                                                    value: () => {
                                                                                        const user = getState('auth.user');
                                                                                        return user?.profile?.preferences?.defaultCategory || 'general';
                                                                                    }
                                                                                }
                                                                            },
                                                                            {
                                                                                button: {
                                                                                    type: 'submit',
                                                                                    className: 'btn',
                                                                                    text: '➕ Add Todo'
                                                                                }
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        },

                                        // Filters with service injection
                                        {
                                            div: {
                                                className: 'filters',
                                                children: [
                                                    {
                                                        div: {
                                                            className: 'filter-group',
                                                            children: [
                                                                { span: { text: 'Show:' } },
                                                                {
                                                                    button: {
                                                                        className: () => {
                                                                            const filter = getState('todos.filter', 'all');
                                                                            return `filter-btn ${filter === 'all' ? 'active' : ''}`;
                                                                        },
                                                                        text: 'All',
                                                                        onClick: () => setState('todos.filter', 'all')
                                                                    }
                                                                },
                                                                {
                                                                    button: {
                                                                        className: () => {
                                                                            const filter = getState('todos.filter', 'all');
                                                                            return `filter-btn ${filter === 'active' ? 'active' : ''}`;
                                                                        },
                                                                        text: 'Active',
                                                                        onClick: () => setState('todos.filter', 'active')
                                                                    }
                                                                },
                                                                {
                                                                    button: {
                                                                        className: () => {
                                                                            const filter = getState('todos.filter', 'all');
                                                                            return `filter-btn ${filter === 'completed' ? 'active' : ''}`;
                                                                        },
                                                                        text: 'Completed',
                                                                        onClick: () => setState('todos.filter', 'completed')
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        button: {
                                                            className: 'btn btn-secondary',
                                                            text: () => {
                                                                const stats = TodoManagerService?.getStats() || {};
                                                                return `🗑️ Clear Completed (${stats.completed || 0})`;
                                                            },
                                                            style: () => {
                                                                const stats = TodoManagerService?.getStats() || {};
                                                                return { display: stats.completed > 0 ? 'inline-flex' : 'none' };
                                                            },
                                                            onClick: () => {
                                                                const stats = TodoManagerService?.getStats() || {};
                                                                if (confirm(`Delete ${stats.completed} completed todos?`)) {
                                                                    TodoManagerService?.clearCompleted();
                                                                }
                                                            }
                                                        }
                                                    }
                                                ]
                                            }
                                        },

                                        // Todo List with service injection
                                        {
                                            div: {
                                                className: 'todo-list',
                                                children: () => {
                                                    const filter = getState('todos.filter', 'all');
                                                    const search = getState('todos.search', '');
                                                    const selectedCategory = getState('todos.selectedCategory', 'all');
                                                    
                                                    // Get todo service from service injection
                                                    const filteredTodos = TodoManagerService?.getFilteredTodos(filter, search, selectedCategory) || [];

                                                    if (filteredTodos.length === 0) {
                                                        const emptyMessages = {
                                                            all: 'No todos yet. Add one above!',
                                                            active: 'No active todos. Great job!',
                                                            completed: 'No completed todos yet.'
                                                        };

                                                        return [
                                                            {
                                                                div: {
                                                                    className: 'empty-state',
                                                                    children: [
                                                                        {
                                                                            div: {
                                                                                className: 'empty-state-icon',
                                                                                text: filter === 'completed' ? '🎉' : '📝'
                                                                            }
                                                                        },
                                                                        {
                                                                            h3: {
                                                                                text: filter === 'completed' ? 'All Done!' : 'No Todos Found'
                                                                            }
                                                                        },
                                                                        {
                                                                            p: {
                                                                                text: emptyMessages[filter] || emptyMessages.all
                                                                            }
                                                                        }
                                                                    ]
                                                                }
                                                            }
                                                        ];
                                                    }

                                                    return filteredTodos.map(todo => ({
                                                        div: {
                                                            className: `todo-item ${todo.completed ? 'completed' : ''}`,
                                                            children: [
                                                                {
                                                                    div: {
                                                                        className: 'todo-content',
                                                                        children: [
                                                                            {
                                                                                input: {
                                                                                    type: 'checkbox',
                                                                                    className: 'todo-checkbox',
                                                                                    checked: todo.completed,
                                                                                    onChange: () => {
                                                                                        TodoManagerService?.toggleTodo(todo.id);
                                                                                    }
                                                                                }
                                                                            },
                                                                            {
                                                                                div: {
                                                                                    className: 'todo-details',
                                                                                    children: [
                                                                                        {
                                                                                            div: {
                                                                                                className: 'todo-text',
                                                                                                text: todo.text
                                                                                            }
                                                                                        },
                                                                                        {
                                                                                            div: {
                                                                                                className: 'todo-meta',
                                                                                                children: [
                                                                                                    {
                                                                                                        span: {
                                                                                                            className: `priority priority-${todo.priority}`,
                                                                                                            text: {
                                                                                                                high: '🔴 High',
                                                                                                                medium: '🟡 Medium',
                                                                                                                low: '🟢 Low'
                                                                                                            }[todo.priority]
                                                                                                        }
                                                                                                    },
                                                                                                    {
                                                                                                        span: {
                                                                                                            className: 'category',
                                                                                                            text: `📂 ${todo.category}`
                                                                                                        }
                                                                                                    },
                                                                                                    {
                                                                                                        span: {
                                                                                                            className: 'todo-date',
                                                                                                            text: `📅 ${new Date(todo.createdAt).toLocaleDateString()}`
                                                                                                        }
                                                                                                    }
                                                                                                ]
                                                                                            }
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            },
                                                                            {
                                                                                div: {
                                                                                    className: 'todo-actions',
                                                                                    children: [
                                                                                        {
                                                                                            button: {
                                                                                                className: 'btn btn-danger btn-small',
                                                                                                text: '🗑️ Delete',
                                                                                                onClick: () => {
                                                                                                    if (confirm('Delete this todo?')) {
                                                                                                        services.TodoManagerService?.deleteTodo(todo.id);
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }));
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    })
});

// Enhanced Homepage
const HomePage = (props, context) => ({
    render: () => ({
        div: {
            className: 'main-content',
            children: [
                {
                    div: {
                        className: 'container',
                        children: [
                            {
                                div: {
                                    className: 'page-content',
                                    children: [
                                        {
                                            div: {
                                                className: 'hero-section',
                                                children: [
                                                    {
                                                        h1: {
                                                            className: 'page-title',
                                                            text: '✅ TodoMaster Multi-User',
                                                            style: { fontSize: '3rem', textAlign: 'center' }
                                                        }
                                                    },
                                                    {
                                                        p: {
                                                            className: 'page-subtitle',
                                                            text: 'Experience the complete JurisJS framework with multi-user todo management. Each user gets their own private workspace with advanced features.',
                                                            style: { fontSize: '1.2rem', textAlign: 'center', maxWidth: '800px', margin: '0 auto 2rem' }
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            className: 'hero-buttons',
                                                            children: () => {
                                                                const isAuthenticated = context.getState('auth.isAuthenticated', false);
                                                                const user = context.getState('auth.user');
                                                                
                                                                if (isAuthenticated) {
                                                                    return [
                                                                        {
                                                                            div: {
                                                                                style: { textAlign: 'center', marginBottom: '1rem' },
                                                                                children: [
                                                                                    {
                                                                                        p: {
                                                                                            text: `Welcome back, ${user?.profile?.displayName || user?.username}! 👋`,
                                                                                            style: { fontSize: '1.1rem', color: '#c4b5fd', marginBottom: '1rem' }
                                                                                        }
                                                                                    }
                                                                                ]
                                                                            }
                                                                        },
                                                                        {
                                                                            a: {
                                                                                href: '#/todos',
                                                                                className: 'btn',
                                                                                style: { fontSize: '1.1rem', padding: '1rem 2rem' },
                                                                                text: '📋 Go to My Todos',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/todos');
                                                                                }
                                                                            }
                                                                        },
                                                                        {
                                                                            a: {
                                                                                href: '#/profile',
                                                                                className: 'btn btn-secondary',
                                                                                style: { fontSize: '1.1rem', padding: '1rem 2rem' },
                                                                                text: '👤 My Profile',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/profile');
                                                                                }
                                                                            }
                                                                        }
                                                                    ];
                                                                } else {
                                                                    return [
                                                                        {
                                                                            a: {
                                                                                href: '#/register',
                                                                                className: 'btn',
                                                                                style: { fontSize: '1.1rem', padding: '1rem 2rem' },
                                                                                text: '📝 Get Started',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/register');
                                                                                }
                                                                            }
                                                                        },
                                                                        {
                                                                            a: {
                                                                                href: '#/login',
                                                                                className: 'btn btn-secondary',
                                                                                style: { fontSize: '1.1rem', padding: '1rem 2rem' },
                                                                                text: '🔑 Sign In',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/login');
                                                                                }
                                                                            }
                                                                        },
                                                                        {
                                                                            a: {
                                                                                href: '#/users',
                                                                                className: 'btn btn-secondary',
                                                                                style: { fontSize: '1rem', padding: '0.8rem 1.5rem' },
                                                                                text: '👥 View Users',
                                                                                onClick: (e) => {
                                                                                    e.preventDefault();
                                                                                    context.navigate('/users');
                                                                                }
                                                                            }
                                                                        }
                                                                    ];
                                                                }
                                                            }
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            style: { 
                                                                marginTop: '3rem', 
                                                                padding: '2rem', 
                                                                background: 'rgba(255, 255, 255, 0.05)', 
                                                                borderRadius: '12px',
                                                                border: '1px solid rgba(255, 255, 255, 0.1)'
                                                            },
                                                            children: [
                                                                {
                                                                    h3: {
                                                                        text: '🚀 Multi-User Features',
                                                                        style: { color: '#ffd700', marginBottom: '1.5rem', textAlign: 'center' }
                                                                    }
                                                                },
                                                                {
                                                                    div: {
                                                                        style: { 
                                                                            display: 'grid', 
                                                                            gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', 
                                                                            gap: '1.5rem' 
                                                                        },
                                                                        children: [
                                                                            {
                                                                                div: {
                                                                                    style: { textAlign: 'center' },
                                                                                    children: [
                                                                                        { div: { text: '👤', style: { fontSize: '2rem', marginBottom: '0.5rem' } } },
                                                                                        { h4: { text: 'Private Workspaces', style: { color: '#c4b5fd', marginBottom: '0.5rem' } } },
                                                                                        { p: { text: 'Each user has their own isolated todo workspace with private data', style: { fontSize: '0.9rem' } } }
                                                                                    ]
                                                                                }
                                                                            },
                                                                            {
                                                                                div: {
                                                                                    style: { textAlign: 'center' },
                                                                                    children: [
                                                                                        { div: { text: '🔐', style: { fontSize: '2rem', marginBottom: '0.5rem' } } },
                                                                                        { h4: { text: 'Secure Authentication', style: { color: '#c4b5fd', marginBottom: '0.5rem' } } },
                                                                                        { p: { text: 'User registration, login, and session management with persistent storage', style: { fontSize: '0.9rem' } } }
                                                                                    ]
                                                                                }
                                                                            },
                                                                            {
                                                                                div: {
                                                                                    style: { textAlign: 'center' },
                                                                                    children: [
                                                                                        { div: { text: '📊', style: { fontSize: '2rem', marginBottom: '0.5rem' } } },
                                                                                        { h4: { text: 'User Profiles', style: { color: '#c4b5fd', marginBottom: '0.5rem' } } },
                                                                                        { p: { text: 'Customizable profiles, statistics, and data export functionality', style: { fontSize: '0.9rem' } } }
                                                                                    ]
                                                                                }
                                                                            },
                                                                            {
                                                                                div: {
                                                                                    style: { textAlign: 'center' },
                                                                                    children: [
                                                                                        { div: { text: '💾', style: { fontSize: '2rem', marginBottom: '0.5rem' } } },
                                                                                        { h4: { text: 'Data Isolation', style: { color: '#c4b5fd', marginBottom: '0.5rem' } } },
                                                                                        { p: { text: 'User data is completely separated with individual storage per user', style: { fontSize: '0.9rem' } } }
                                                                                    ]
                                                                                }
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                }
            ]
        }
    })
});
const Footer = (props, context) => ({
    footer: {}
});

// =================================================================
// APP INITIALIZATION
// =================================================================

// Enhanced Route Guards
const authGuard = async (context) => {
    const isAuthenticated = context.getState('auth.isAuthenticated', false);
    if (!isAuthenticated) {
        // Check if there's a valid session that hasn't been loaded yet
        const savedSession = localStorage.getItem('juris_current_session');
        if (savedSession) {
            try {
                const sessionData = JSON.parse(savedSession);
                if (sessionData.expires > Date.now()) {
                    const user = UserDatabase.getUserById(sessionData.userId);
                    if (user) {
                        // Restore the session
                        context.setState('auth.user', user);
                        context.setState('auth.isAuthenticated', true);
                        context.setState('auth.sessionId', sessionData.sessionId);
                        console.log('✅ Session restored in route guard:', user.username);
                        return true;
                    }
                }
            } catch (error) {
                console.error('Failed to restore session in route guard:', error);
                localStorage.removeItem('juris_current_session');
            }
        }
        
        alert('Please log in to access this page.');
        context.navigate('/login');
        return false;
    }
    return true;
};

const guestGuard = async (context) => {
    const isAuthenticated = context.getState('auth.isAuthenticated', false);
    if (isAuthenticated) {
        context.navigate('/todos');
        return false;
    }
    
    // Check if there's a valid session for guest routes too
    const savedSession = localStorage.getItem('juris_current_session');
    if (savedSession) {
        try {
            const sessionData = JSON.parse(savedSession);
            if (sessionData.expires > Date.now()) {
                const user = UserDatabase.getUserById(sessionData.userId);
                if (user) {
                    context.navigate('/todos');
                    return false;
                }
            }
        } catch (error) {
            console.error('Failed to check session in guest guard:', error);
        }
    }
    
    return true;
};

// Initialize the Multi-User Juris app
const app = new Juris({
    // Initial state
    states: {
        auth: {
            isAuthenticated: false,
            user: null,
            sessionId: null,
            isLoading: false,
            error: null
        },
        todos: {
            items: [],
            filter: 'all',
            search: '',
            selectedCategory: 'all',
            lastAction: null
        },
        sync: {
            status: 'idle',
            lastSync: null,
            error: null
        },
        profile: {
            isUpdating: false,
            updateMessage: null
        },
        router: {
            currentRoute: '/'
        }
    },

    // Register all components
    components: {
        // Headless Components (Background Services)
        AuthService,
        TodoStorageService,
        TodoManagerService,
        UserManagementService,
        FooterLoader,
        
        // UI Components
        Navigation,
        SyncStatus,
        PrivacyDisclaimer,
        HomePage,
        LoginPage,
        RegisterPage,
        TodosPage,
        ProfilePage,
        UsersPage
    },

    // Enhanced Router configuration
    router: {
        mode: 'hash',
        routes: {
            '/': {
                component: 'HomePage',
                meta: { title: 'TodoMaster - Multi-User Demo' }
            },
            '/login': {
                component: 'LoginPage',
                guards: [guestGuard],
                meta: { title: 'Login - TodoMaster' }
            },
            '/register': {
                component: 'RegisterPage',
                guards: [guestGuard],
                meta: { title: 'Register - TodoMaster' }
            },
            '/todos': {
                component: 'TodosPage',
                guards: [authGuard],
                meta: { title: 'My Todos - TodoMaster' }
            },
            '/profile': {
                component: 'ProfilePage',
                guards: [authGuard],
                meta: { title: 'Profile - TodoMaster' }
            },
            '/users': {
                component: 'UsersPage',
                meta: { title: 'Users - TodoMaster' }
            }
        },
        guards: { authGuard, guestGuard }
    },

    // Main layout
    layout: {
        div: {
            children: [
                { Navigation: {} },
                { Router: {} },
                { SyncStatus: {} },
                { PrivacyDisclaimer: {} },
            ]
        }
    }
});

// Update current route state for navigation
app.subscribe('router.currentRoute', (route) => {
    document.title = {
        '/': 'TodoMaster - Multi-User Demo',
        '/login': 'Login - TodoMaster',
        '/register': 'Register - TodoMaster',
        '/todos': 'My Todos - TodoMaster',
        '/profile': 'Profile - TodoMaster',
        '/users': 'Users - TodoMaster'
    }[route] || 'TodoMaster';
});

// Render the application
app.render();

// Make app available for debugging
window.app = app;

// Display system info
console.log('🎉 TodoMaster Multi-User Demo loaded!');
console.log('💡 Access app via window.app for debugging');
console.log('👥 Multi-user system with isolated data per user');
console.log('🔐 Complete authentication & session management');
console.log('📋 User-specific todo management with profiles');
console.log('💾 Individual data storage per user');
console.log('🛣️ Routes: /, /login, /register, /todos, /profile, /users');
console.log('⚡ Zero build process - pure JurisJS framework!');

// Display user database for demo purposes
console.log('📊 User Database:', UserDatabase.getAllUsers());

// Mobile debugging - check what's available
MobileDebugger.log('App initialization complete', {
    app: !!window.app,
    todoHelpers: !!window.todoHelpers,
    userHelpers: !!window.userHelpers,
    userHelpersKeys: window.userHelpers ? Object.keys(window.userHelpers) : null,
    todoHelpersKeys: window.todoHelpers ? Object.keys(window.todoHelpers) : null
});

console.timeEnd('juris_todomaster_multiuser_demo');
const end = performance.now();
const renderTime = end - start;
document.getElementById('render-time').textContent = `Rendered in ${renderTime.toFixed(2)}ms`;
</script>
</body>
</html> 